name: Commit Content from GPT

on:
  workflow_dispatch:        # âœ… Enables manual and API-triggered runs
  schedule:
    - cron: "0 */6 * * *"   # âœ… Every 6 hours

jobs:
  sync-gpt-output:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config --global user.name "Augmented Teams GPT"
          git config --global user.email "gpt@openai.com"

      - name: Commit GPT-created files
        run: |
          echo "ğŸ” Checking for GPT-generated changes..."
          
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "ğŸ“ Found changes to commit:"
            git status --porcelain
            
            git add .
            git commit -m "ğŸ¤– Auto-sync: Add or update GPT-generated content"
            git push origin main
            
            echo "âœ… Changes committed and pushed successfully"
          else
            echo "âœ… Nothing to commit - repository is clean"
          fi

      - name: Update vector database if content changed
        run: |
          echo "ğŸ”„ Checking if vector database needs updating..."
          
          # Check if any content files were modified
          if git diff --name-only HEAD~1 HEAD | grep -E '\.(md|txt|docx|xlsx|pptx|pdf)$'; then
            echo "ğŸ“š Content files changed - triggering vector reindex"
            
            # Trigger vector search reindexing
            curl -X POST \
              -H "Accept: application/json" \
              "http://localhost:8000/reindex" \
              || echo "âš ï¸ Vector search service not available - manual reindex may be needed"
          else
            echo "âœ… No content files changed - vector database up to date"
          fi
