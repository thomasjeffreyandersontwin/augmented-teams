name: Deploy Test Feature

on:
  push:
    branches: [ main ]
    paths: [ 'features/containerization/test-feature/**' ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: augmentedteams-hfdzfjhghshucaf6.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./features/containerization/test-feature
        file: ./features/containerization/test-feature/config/Dockerfile
        push: true
        tags: |
          augmentedteams-hfdzfjhghshucaf6.azurecr.io/test-feature:latest
          augmentedteams-hfdzfjhghshucaf6.azurecr.io/test-feature:${{ github.sha }}
        
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure Container Apps
      run: |
        # Check if container app exists, create or update
        if az containerapp show --name test-feature --resource-group AugmentedTeams &>/dev/null; then
          echo "ðŸ“¦ Updating existing container app..."
          az containerapp update \
            --name test-feature \
            --resource-group AugmentedTeams \
            --image augmentedteams-hfdzfjhghshucaf6.azurecr.io/test-feature:latest
        else
          echo "ðŸš€ Creating new container app..."
          az containerapp create \
            --name test-feature \
            --resource-group AugmentedTeams \
            --environment managedEnvironment-AugmentedTeams-aa2c \
            --image augmentedteams-hfdzfjhghshucaf6.azurecr.io/test-feature:latest \
            --registry-server augmentedteams-hfdzfjhghshucaf6.azurecr.io \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --target-port 8000 \
            --ingress external \
            --cpu 0.25 \
            --memory 0.5Gi
        fi
        echo "âœ… Container App deployed successfully!"
