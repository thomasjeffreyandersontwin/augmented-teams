name: Deploy Features

on:
  push:
    branches: [ main ]
    paths: [ 'features/containerization/**' ]
  workflow_dispatch:

jobs:
  detect-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Detect changed features
      id: detect
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # Manual trigger - deploy all features
          FEATURES=$(ls features/containerization/ | grep -v "^_" | grep -v "^containerization$" | tr '\n' ' ')
          echo "features=$FEATURES" >> $GITHUB_OUTPUT
        else
          # Auto-detect changed features - look at last 3 commits to be safe
          FEATURES=$(git log --name-only --format="" -1 --diff-filter=ACMR | grep '^features/containerization/[^/]*/' | cut -d'/' -f3 | sort -u | tr '\n' ' ')
          
          # If no features found, try listing all features
          if [ -z "$FEATURES" ]; then
            FEATURES=$(ls features/containerization/ | grep -v "^_\|containerization$" | tr '\n' ' ')
          fi
          
          echo "features=$FEATURES" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ“‹ Detected features: $FEATURES"
    
    - name: Install dependencies
      run: |
        pip install docker requests pyyaml fastapi uvicorn pydantic
    
    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: augmentedteams-hfdzfjhghshucaf6.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Provision and deploy changed features
      env:
        ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      run: |
        set -e  # Exit on error
        FEATURES="${{ steps.detect.outputs.features }}"
        
        echo "ğŸ” Checking features to deploy..."
        echo "ğŸ“‹ Features variable: '$FEATURES'"
        
        if [ -z "$FEATURES" ]; then
          echo "âš ï¸ No features detected to deploy"
          echo "âœ… No deployment needed"
          exit 0
        fi
        
        echo "ğŸ“¦ Features to deploy: $FEATURES"
        
        for FEATURE in $FEATURES; do
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Processing feature: $FEATURE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ ! -d "features/containerization/$FEATURE" ]; then
            echo "âŒ Feature directory not found: features/containerization/$FEATURE"
            echo "âš ï¸ Skipping $FEATURE"
            continue
          fi
          
          if [ ! -f "features/containerization/$FEATURE/config/provision-service.py" ]; then
            echo "âŒ Provision script not found: features/containerization/$FEATURE/config/provision-service.py"
            echo "âš ï¸ Skipping $FEATURE"
            continue
          fi
          
          echo "âœ… Starting deployment for $FEATURE..."
          echo "ğŸ“ Command: python features/containerization/$FEATURE/config/provision-service.py AZURE --always"
          
          if python features/containerization/$FEATURE/config/provision-service.py AZURE --always; then
            echo "âœ… Successfully deployed $FEATURE"
          else
            EXIT_CODE=$?
            echo "âŒ Failed to deploy $FEATURE (exit code: $EXIT_CODE)"
            exit $EXIT_CODE
          fi
          
          echo "âœ… $FEATURE deployment completed"
        done
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… All features deployed successfully!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
