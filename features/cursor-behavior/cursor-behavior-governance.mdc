# Behavior Governance (Rules, Commands, MCP)

Purpose: Define how behaviors are authored, referenced, executed, and synchronized across Rules, Commands, and MCP.

## Authoring Model (Per-Feature Localization)
- Author at source under `features/<feature>/cursor/`:
  - Rules: `*.mdc` (governing documents and checklists)
  - Command docs: `*-cmd.md` (human-facing invocation docs)
  - Command functions: `*_cmd.py` (executable code, if applicable)
  - MCP config notes: `*-mcp.json` (fragments/notes; merged manually into root `mcp.json`)

## References (Rules ↔ Commands ↔ MCP)
- Rules must reference the commands they rely on (doc name) and the code functions (file path) if applicable.
- Rules must reference MCP servers/tools used by those commands (server key and tool names).
- Command docs must list:
  - Execution model: AI-only vs Code-backed
  - Referenced rules that motivate/require the command
  - MCP servers/tools they call
- Command functions should include a short header comment indicating:
  - Owning feature, related rule(s), and any MCP tools used

## Execution Models (Be Explicit)
- AI-only commands: guidance/trigger-only, no code function created.
- AI-Code commands: provide `*_cmd.py` implementation (authored in feature `cursor/`, synced to `commands/`).

## Synchronization (Single Source → Environment)
- Feature → env:
  - `python commands/cursor-update-env_cmd.py [--feature <name>]`
  - Copies rules `*.mdc` → `.cursor/rules/`
  - Copies command docs `*-cmd.md` → `.cursor/commands/`
  - Copies command functions `*_cmd.py` → `commands/`
- Env → feature (localize edits made under `.cursor/*`):
  - `python commands/cursor-update-feature-from-env_cmd.py --feature <name>`
  - Copies `.cursor/rules/*.mdc` and `.cursor/commands/*.md` → `features/<feature>/cursor/`

## Indexing and Reporting
- Environment Index: `features/cursor-behavior/cursor-behavior-index.mdc`
  - Lists rules, commands, MCP servers, env checks
  - Updated manually or via automation; synced to `.cursor/rules/` via `cursor-update-env_cmd.py`

## MCP Governance
- MCP usage must be declared in command docs and referenced in rules.
- Use server keys as defined in `mcp.json` (e.g., `tdd-pipeline`).
- Tools to call must be listed by name (e.g., `get_current_step`).
- Secrets must not be stored in docs or code; rely on environment or masked values in config.

## Automation and Change Detection
- On edits under `features/<feature>/cursor/`:
  - Run `cursor-update-env_cmd.py` to sync to `.cursor/*` and `commands/`
  - Index is automatically updated after sync (use `--no-index` to skip)
- On edits under `.cursor/*` that should be localized:
  - Run `cursor-update-feature-from-env_cmd.py --feature <name>`
- CI/Editors can hook these commands to enforce synchronization.

## Maintenance
- When creating or updating a command:
  - Use `@cursor-create-command` to scaffold docs and (optionally) code
  - Declare execution model and MCP dependencies in the doc
  - Sync to environment via `python commands/cursor-update-env_cmd.py` (index auto-updates)
  - See `cursor-command-creation.mdc` for guidance on when and how to build command functions
- Keep rules up to date with the commands and MCP tools they rely on

## Reference Integrity
- **Periodic Reference Audit:** When renaming commands, rules, or files in a feature:
  - Scan all files in that feature (`features/<feature>/`) for references to old names
  - Update cross-references in:
    - Rules (`*.mdc` files)
    - Command docs (`*-cmd.md` files)
    - Code files (`*.py` files referencing command functions)
    - README or documentation files
  - Check the index (`cursor-behavior-index.mdc`) reflects the new names
  - Verify synced locations (`.cursor/rules/`, `.cursor/commands/`, `commands/`) match source names
  - Use grep or search tools to find old references: look for old file names, command names, and function names
- **Before committing renames:** Verify no broken references exist within the feature or in dependent features

## See also
- `features/cursor-behavior/cursor-behavior-pattern.md` — foundational explanation of the pattern (why and what)
- `features/cursor-behavior/cursor-behavior-index.mdc` — the "what" index with generated inventory and report locations