name: Update GPT Instructions

on:
  push:
    paths:
      - 'instructions/**'
      - 'config/**'
  workflow_dispatch:  # Allow manual trigger
  schedule:
    - cron: '0 9 * * 1'  # Weekly sync on Mondays at 9 AM

jobs:
  update-gpt-instructions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper git operations
        
    - name: Validate instruction files
      run: |
        echo "ðŸ” Validating instruction files..."
        
        # Check all instruction files exist
        echo "ðŸ” Checking all instruction files..."
        
        # Find all .md files in instructions directory
        instruction_files=$(find instructions -name "*.md" -type f)
        
        if [ -z "$instruction_files" ]; then
          echo "âŒ No .md files found in instructions directory"
          exit 1
        fi
        
        # Check each instruction file
        for file in $instruction_files; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
        echo "âœ… All instruction files present"
        
    - name: Generate instruction summary
      run: |
        echo "ðŸ“‹ Generating instruction summary..."
        
        # Create a summary of all instruction files
        cat > instruction-summary.md << 'EOF'
        # Instruction Files Summary
        
        Generated: $(date)
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        
        ## Instruction Files Status
        
        EOF
        
        # Add status for each instruction file
        for file in $(find instructions -name "*.md" -type f); do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            size=$(du -h "$file" | cut -f1)
            echo "- **$filename**: $lines lines, $size" >> instruction-summary.md
          fi
        done
        
        echo "" >> instruction-summary.md
        echo "## Configuration Files" >> instruction-summary.md
        echo "- **bootstrap-config.json**: GPT Builder auto-refresh configuration" >> instruction-summary.md
        
        cat instruction-summary.md
        
    - name: Trigger Git Sync Workflow
      run: |
        echo "ðŸ”„ Triggering Git Sync workflow via GitHub API..."
        
        # Trigger the git-sync.yml workflow
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"ref": "main"}' \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/git-sync.yml/dispatches"
        
        echo "âœ… Git Sync workflow triggered successfully"
        echo "ðŸ“‹ This will sync any pending changes and update the repository"
        
    - name: Verify instruction integrity
      run: |
        echo "ðŸ”’ Verifying instruction integrity..."
        
        # Check that instruction files haven't been corrupted
        for file in $(find instructions -name "*.md" -type f); do
          if [ -f "$file" ]; then
            # Basic integrity checks
            if [ -s "$file" ]; then
              echo "âœ… $file has content"
            else
              echo "âŒ $file is empty"
              exit 1
            fi
            
            # Check for basic markdown structure
            if grep -q "^#" "$file"; then
              echo "âœ… $file has proper markdown headers"
            else
              echo "âš ï¸ $file may be missing markdown headers"
            fi
          fi
        done
        
        echo "âœ… Instruction integrity verified"
        
    - name: Create sync report
      run: |
        echo "ðŸ“Š Creating sync report..."
        
        cat > sync-report.md << 'EOF'
        # GPT Builder Sync Report
        
        **Date**: $(date)
        **Repository**: ${{ github.repository }}
        **Branch**: ${{ github.ref_name }}
        **Commit**: ${{ github.sha }}
        **Triggered by**: ${{ github.event_name }}
        
        ## Sync Status: âœ… SUCCESS
        
        ### Files Processed
        EOF
        
        # List all instruction files
        for file in $(find instructions -name "*.md" -type f); do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "- $filename" >> sync-report.md
          fi
        done
        
        echo "" >> sync-report.md
        echo "### Configuration" >> sync-report.md
        echo "- bootstrap-config.json: Auto-refresh enabled" >> sync-report.md
        echo "- Git integration: Read-only mode" >> sync-report.md
        echo "- Write-back: Disabled (explicit only)" >> sync-report.md
        
        echo "" >> sync-report.md
        echo "### Next Steps" >> sync-report.md
        echo "1. GPT Builder will auto-refresh on next startup" >> sync-report.md
        echo "2. Instructions are now live in Builder configuration" >> sync-report.md
        echo "3. No manual intervention required" >> sync-report.md
        
        cat sync-report.md
        
    - name: Update deployment summary
      run: |
        echo "## ðŸ”„ GPT Instructions Update" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Sync Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Files Synced" >> $GITHUB_STEP_SUMMARY
        for file in $(find instructions -name "*.md" -type f); do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "- \`$filename\`" >> $GITHUB_STEP_SUMMARY
          fi
        done
        echo "- \`bootstrap-config.json\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Architecture" >> $GITHUB_STEP_SUMMARY
        echo "- **Flow**: Unidirectional (Git â†’ GPT)" >> $GITHUB_STEP_SUMMARY
        echo "- **Mode**: Auto-refresh on startup" >> $GITHUB_STEP_SUMMARY
        echo "- **Write-back**: Disabled (explicit only)" >> $GITHUB_STEP_SUMMARY
        echo "- **Source of Truth**: Git repository" >> $GITHUB_STEP_SUMMARY
