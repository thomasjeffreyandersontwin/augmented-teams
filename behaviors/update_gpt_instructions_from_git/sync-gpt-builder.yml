name: Sync GPT Builder Instructions

on:
  push:
    paths:
      - 'instructions/**'
      - 'config/**'
  workflow_dispatch:  # Allow manual trigger
  schedule:
    - cron: '0 9 * * 1'  # Weekly sync on Mondays at 9 AM

jobs:
  sync-gpt-builder:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper git operations
        
    - name: Validate instruction files
      run: |
        echo "ðŸ” Validating instruction files..."
        
        # Check required instruction files exist
        required_files=(
          "instructions/OPERATING_MODEL.md"
          "instructions/STYLE_GUIDE.md"
          "instructions/TOOLS.md"
          "instructions/EXAMPLES.md"
          "instructions/PURPOSE.md"
          "config/bootstrap-config.json"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
        echo "âœ… All required instruction files present"
        
    - name: Generate instruction summary
      run: |
        echo "ðŸ“‹ Generating instruction summary..."
        
        # Create a summary of all instruction files
        cat > instruction-summary.md << 'EOF'
        # Instruction Files Summary
        
        Generated: $(date)
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        
        ## Instruction Files Status
        
        EOF
        
        # Add status for each instruction file
        for file in instructions/*.md; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            size=$(du -h "$file" | cut -f1)
            echo "- **$filename**: $lines lines, $size" >> instruction-summary.md
          fi
        done
        
        echo "" >> instruction-summary.md
        echo "## Configuration Files" >> instruction-summary.md
        echo "- **bootstrap-config.json**: GPT Builder auto-refresh configuration" >> instruction-summary.md
        
        cat instruction-summary.md
        
    - name: Trigger GPT Builder sync
      uses: openai/api_github_com__jit_plugin.triggerGitSync@main
      with:
        ref: main
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        
    - name: Verify instruction integrity
      run: |
        echo "ðŸ”’ Verifying instruction integrity..."
        
        # Check that instruction files haven't been corrupted
        for file in instructions/*.md; do
          if [ -f "$file" ]; then
            # Basic integrity checks
            if [ -s "$file" ]; then
              echo "âœ… $file has content"
            else
              echo "âŒ $file is empty"
              exit 1
            fi
            
            # Check for basic markdown structure
            if grep -q "^#" "$file"; then
              echo "âœ… $file has proper markdown headers"
            else
              echo "âš ï¸ $file may be missing markdown headers"
            fi
          fi
        done
        
        echo "âœ… Instruction integrity verified"
        
    - name: Create sync report
      run: |
        echo "ðŸ“Š Creating sync report..."
        
        cat > sync-report.md << 'EOF'
        # GPT Builder Sync Report
        
        **Date**: $(date)
        **Repository**: ${{ github.repository }}
        **Branch**: ${{ github.ref_name }}
        **Commit**: ${{ github.sha }}
        **Triggered by**: ${{ github.event_name }}
        
        ## Sync Status: âœ… SUCCESS
        
        ### Files Processed
        EOF
        
        # List all instruction files
        for file in instructions/*.md; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "- $filename" >> sync-report.md
          fi
        done
        
        echo "" >> sync-report.md
        echo "### Configuration" >> sync-report.md
        echo "- bootstrap-config.json: Auto-refresh enabled" >> sync-report.md
        echo "- Git integration: Read-only mode" >> sync-report.md
        echo "- Write-back: Disabled (explicit only)" >> sync-report.md
        
        echo "" >> sync-report.md
        echo "### Next Steps" >> sync-report.md
        echo "1. GPT Builder will auto-refresh on next startup" >> sync-report.md
        echo "2. Instructions are now live in Builder configuration" >> sync-report.md
        echo "3. No manual intervention required" >> sync-report.md
        
        cat sync-report.md
        
    - name: Update deployment summary
      run: |
        echo "## ðŸ”„ GPT Builder Instruction Sync" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Sync Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Files Synced" >> $GITHUB_STEP_SUMMARY
        for file in instructions/*.md; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "- \`$filename\`" >> $GITHUB_STEP_SUMMARY
          fi
        done
        echo "- \`bootstrap-config.json\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Architecture" >> $GITHUB_STEP_SUMMARY
        echo "- **Flow**: Unidirectional (Git â†’ GPT Builder)" >> $GITHUB_STEP_SUMMARY
        echo "- **Mode**: Auto-refresh on startup" >> $GITHUB_STEP_SUMMARY
        echo "- **Write-back**: Disabled (explicit only)" >> $GITHUB_STEP_SUMMARY
        echo "- **Source of Truth**: Git repository" >> $GITHUB_STEP_SUMMARY
