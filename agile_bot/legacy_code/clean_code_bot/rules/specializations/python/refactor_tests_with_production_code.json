{
  "language": "python",
  "description": "CRITICAL: When refactoring Python production code, update tests immediately using pytest patterns. Tests should verify behavior, not implementation details.",
  "examples": [
    {
      "do": {
        "description": "Update Python tests in parallel with production refactoring",
        "content": [
          "Update tests as you refactor production code",
          "Use pytest fixtures for common test setup",
          "Create test_helpers.py with verification functions",
          "Use conftest.py for shared fixtures across test files",
          "Keep builds green throughout refactoring",
          "",
          "Correct Examples (Python test refactoring):",
          "",
          "# BEFORE: Duplicated test setup in each test file",
          "# test_action1.py",
          "def test_action_tracks_start():",
          "    workspace = tmp_path / 'workspace'",
          "    workspace.mkdir()",
          "    log_dir = workspace / 'agile_bot/bots/test_bot/project_area'",
          "    log_dir.mkdir(parents=True)",
          "    action = Action('test_bot', 'behavior', workspace)",
          "    action.track_activity_on_start()",
          "    # assert logic...",
          "",
          "# AFTER: Extract to pytest fixture and helper",
          "# conftest.py",
          "@pytest.fixture",
          "def workspace_root(tmp_path):",
          "    workspace = tmp_path / 'workspace'",
          "    workspace.mkdir()",
          "    return workspace",
          "",
          "# test_helpers.py",
          "def verify_action_tracks_start(workspace, action_class, action_name, behavior='discovery'):",
          "    action = action_class('test_bot', behavior, workspace)",
          "    action.track_activity_on_start()",
          "    log_data = read_activity_log(workspace, 'test_bot')",
          "    assert any(e['action_state'] == f'test_bot.{behavior}.{action_name}' for e in log_data)",
          "",
          "# test_action1.py",
          "def test_action_tracks_start(workspace_root):",
          "    verify_action_tracks_start(workspace_root, ActionClass, 'action_name')",
          "",
          "Python-Specific Test Patterns:",
          "- Use pytest fixtures (@pytest.fixture) for setup",
          "- Create verify_* helper functions for assertions",
          "- Use conftest.py for shared fixtures",
          "- Use parametrize for data-driven tests",
          "- Mock external dependencies with unittest.mock or pytest-mock",
          "",
          "Refactoring BaseAction example:",
          "# 1. Create BaseAction in production",
          "class BaseAction:",
          "    def __init__(self, bot_name, behavior, workspace_root, action_name):",
          "        self.bot_name = bot_name",
          "        self.behavior = behavior",
          "        self.workspace_root = Path(workspace_root)",
          "        self.action_name = action_name",
          "",
          "# 2. Update action classes to inherit",
          "class GatherContextAction(BaseAction):",
          "    def __init__(self, bot_name, behavior, workspace_root):",
          "        super().__init__(bot_name, behavior, workspace_root, 'gather_context')",
          "",
          "# 3. Update tests immediately",
          "from agile_bot.bots.base_bot.src.bot.gather_context_action import GatherContextAction",
          "",
          "def test_gather_context_action(workspace_root):",
          "    action = GatherContextAction('test_bot', 'discovery', workspace_root)",
          "    # Test still works with new inheritance!"
        ]
      },
      "dont": {
        "description": "Don't let Python tests break during refactoring",
        "content": [
          "Don't refactor production without updating imports",
          "Don't leave broken tests 'to fix later'",
          "Don't duplicate test setup code across files",
          "Don't make tests depend on private methods",
          "",
          "Wrong Examples (broken during refactoring):",
          "",
          "# BAD: Move file but don't update imports",
          "# Production: moved src/actions/gather_context.py â†’ src/bot/gather_context_action.py",
          "# Test: Still has old import",
          "from agile_bot.bots.base_bot.src.actions.gather_context import GatherContextAction  # ImportError!",
          "",
          "# BAD: Create BaseAction but tests still expect old structure",
          "# Production: All actions now inherit from BaseAction",
          "# Test: Still testing old __init__ signature",
          "def test_old_init():",
          "    action = GatherContextAction('bot', 'behavior', workspace)",
          "    assert hasattr(action, 'tracker')  # Fails because BaseAction changed init!",
          "",
          "# BAD: Duplicate test setup instead of fixtures",
          "# test_action1.py",
          "def test_something():",
          "    workspace = tmp_path / 'workspace'",
          "    workspace.mkdir()",
          "    log_dir = workspace / 'project_area'",
          "    log_dir.mkdir(parents=True)",
          "    # ... 10 lines of setup",
          "",
          "# test_action2.py - SAME setup duplicated!",
          "def test_something_else():",
          "    workspace = tmp_path / 'workspace'",
          "    workspace.mkdir()",
          "    log_dir = workspace / 'project_area'",
          "    log_dir.mkdir(parents=True)",
          "    # ... 10 lines of setup AGAIN",
          "",
          "Python Test Breakage Indicators (FIX IMMEDIATELY):",
          "- ImportError after moving files",
          "- AttributeError after refactoring classes",
          "- Tests checking private methods (_method_name)",
          "- Duplicate setup code in multiple test files",
          "- Tests that break when changing internal implementation",
          "",
          "Refactoring Strategy for Python:",
          "1. Run pytest before starting: pytest -v",
          "2. Make small production change (e.g., create BaseAction)",
          "3. Update imports in tests immediately",
          "4. Update test instantiation if needed",
          "5. Run pytest again: pytest -v (should pass!)",
          "6. Extract duplicate test code to fixtures/helpers",
          "7. Update conftest.py with shared fixtures",
          "8. Use test_helpers.py for verification functions"
        ]
      }
    }
  ]
}

