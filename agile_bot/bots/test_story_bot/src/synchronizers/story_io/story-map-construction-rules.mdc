---
description: Rules for constructing a story map from a story graph JSON structure
globs: ["**/story-graph.json", "**/story-map-outline.drawio", "**/story-map*.drawio"]
alwaysApply: false
---

**When** constructing a story map from a story graph JSON structure,
**then** follow these rules to transform the hierarchical graph data into a visual DrawIO diagram layout.

## Overview

A story graph is a hierarchical JSON structure containing epics, sub-epics (features), and stories. The story map visualizes this hierarchy as a horizontal flow diagram with vertical nesting for optional and alternative paths.

---

## 1. Graph Structure Hierarchy

The story graph follows this hierarchy:
- **Epics** (top level) → contain `sub_epics`
- **Sub-Epics** (also called "features") → contain `story_groups` (can have multiple levels - a sub-epic can contain sub-epics)
- **Story Groups** → contain `stories` and have `type` (and/or) and `connector` (and/or/opt/null)
- **Stories** → contain `acceptance_criteria` (optional) - **NO nested stories**

### Graph JSON Properties

**Epic Properties:**
- `name`: Epic name (string)
- `sequential_order`: Order for horizontal positioning (integer)
- `sub_epics`: Array of sub-epics

**Sub-Epic Properties:**
- `name`: Sub-epic name (string)
- `sequential_order`: Order for horizontal positioning within epic (integer)
- `sub_epics`: Array of nested sub-epics (optional, for multi-level nesting)
- `story_groups`: Array of story groups (required)

**Story Group Properties:**
- `type`: Layout type - `"and"` (horizontal, left-to-right) or `"or"` (vertical, top-to-bottom)
- `connector`: How this group connects to previous group - `"and"` (horizontal), `"or"` (vertical), `"opt"` (optional), or `null` (first group)
- `stories`: Array of stories within this group

**Story Properties:**
- `name`: Story name (string)
- `sequential_order`: Order for positioning within story group (integer)
- `connector`: Flow type - `"and"` (sequential), `"or"` (alternative), `"opt"` (optional)
- `users`: Array of user names (strings)
- `story_type`: `"user"`, `"system"`, or `"technical"` (default: `"user"`)
- `acceptance_criteria`: Array of acceptance criteria objects (optional)
- **NO nested stories** - stories are flat within story groups

---

## 2. Visual Layout Rules

### 2.1 Vertical Positioning (Y-axis)

**Fixed Y Positions:**
- **Epics**: `y = 130`, height = `60`
- **Sub-Epics**: `y = 200`, height = `70`
- **Stories (sequential)**: `y = 337+`, height = `50`, width = `50`
- **Users**: `y = 277-290`, height = `50`, width = `50` (positioned above stories)

**Vertical Spacing Rules:**
- Stories with `connector="opt"` (optional): Place below sequential stories
  - First optional story: `y = 402` (65px below base story row at y=337)
  - Additional optional stories: Stack vertically with ~55px spacing according to `sequential_order`
- Stories with `connector="or"` (alternatives): Position identically to `connector="opt"` stories - appear below sequential stories
- **Story Groups**: Story groups are traversed left-to-right, top-to-bottom (same as stories)
  - Story groups with `type="and"`: Stories arranged horizontally (left-to-right)
  - Story groups with `type="or"`: Stories arranged vertically (top-to-bottom)
  - Story groups with `connector="or"`: Positioned below previous group (vertical stacking)
  - Story groups with `connector="and"`: Positioned to the right of previous group (horizontal flow)

### 2.2 Horizontal Positioning (X-axis)

**Horizontal Flow:**
- **Epics**: Arranged left-to-right by `sequential_order`, starting at `x = 20`
- **Sub-Epics**: Arranged left-to-right within their epic by `sequential_order`, starting at epic's `x + 10`
  - **Nested Sub-Epics**: Sub-epics can contain sub-epics (sub-sub, sub-sub-sub, etc.)
    - First level of nested sub-epics: Narrow the Y-position on the parent sub-epic
    - If more nested levels exist: Widen the whole sub-epic area to accommodate Y-positions and add nested sub-epic layer below its parent
- **Story Groups**: Traversed left-to-right, top-to-bottom within their sub-epic
  - Story groups with `connector="and"` or `connector=null`: Positioned horizontally (left-to-right)
  - Story groups with `connector="or"`: Positioned vertically (top-to-bottom, below previous group)
  - Story groups with `type="and"`: Stories within group arranged horizontally (left-to-right)
  - Story groups with `type="or"`: Stories within group arranged vertically (top-to-bottom)
- **Stories**: Arranged within their story group according to group `type` and story `sequential_order`
  - In `type="and"` groups: Left-to-right by `sequential_order`
  - In `type="or"` groups: Top-to-bottom by `sequential_order`
  - Base spacing: `60px` between story centers horizontally (`STORY_SPACING_X = 60`)
  - Vertical spacing: ~55px between stories vertically
  - Stories start at sub-epic's `x + 12` (to align with epic's left edge)

**Width Calculation:**
- **Epic width**: Spans all its sub-epics plus padding
  - **Important**: Start with wider epics (generous width estimates) - you can shrink them later if needed
  - Better to have extra space than overlapping elements
  - Width should accommodate all sub-epics horizontally without overlap
- **Sub-epic width**: Spans all its story groups plus padding
  - **Important**: Start with wider sub-epics - you can shrink them later if needed
  - Must accommodate all story groups horizontally (for `connector="and"` groups) and vertically (for `connector="or"` groups)
  - If sub-epic contains nested sub-epics, width must span all nested sub-epics
- **Story Group width**: Spans all its stories plus padding
  - For `type="and"` groups: Width = sum of story widths + spacing
  - For `type="or"` groups: Width = widest story (usually 50px)
- **Story width**: Fixed `50px` (square)

---

## 3. Visual Element Styles

### 3.1 Epics
- **Style**: `rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontColor=#000000;`
- **Color**: Purple/lavender (#e1d5e7)
- **Shape**: Rounded rectangle
- **Height**: 60px
- **Position**: Top row (y=130)

### 3.2 Sub-Epics (Features)
- **Style**: `rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontColor=#000000;`
- **Color**: Green (#d5e8d4)
- **Shape**: Rounded rectangle
- **Height**: 70px
- **Position**: Second row (y=200), horizontally within epic
- **Nested Sub-Epics**: Sub-epics can contain sub-epics (sub-sub, sub-sub-sub, etc.)
  - First level of nested sub-epics: Narrow the Y-position on the parent sub-epic
  - If more nested levels exist: Widen the whole sub-epic area to accommodate Y-positions and add nested sub-epic layer below its parent

### 3.3 Stories
- **Style**: `whiteSpace=wrap;html=1;aspect=fixed;fillColor=#fff2cc;strokeColor=#d6b656;fontColor=#000000;fontSize=8;`
- **Color**: Yellow (#fff2cc) for user stories
- **Shape**: Square (50x50)
- **Position**: Third row and below (y=337+)
- **Story Type Variations**:
  - `story_type="user"`: Yellow (#fff2cc) - default
  - `story_type="system"`: Dark blue (#1a237e) with white text
  - `story_type="technical"`: Black (#000000) with white text

### 3.4 Users
- **Style**: `whiteSpace=wrap;html=1;aspect=fixed;fillColor=#dae8fc;strokeColor=#6c8ebf;fontColor=#000000;fontSize=8;`
- **Color**: Blue (#dae8fc)
- **Shape**: Circle/square (50x50)
- **Position**: Above stories (y=277-290), aligned with story x-position
- **Rendering**: If there are multiple AND stories (sequential stories) with the same user, show the user circle only above the first story. Only show the user circle again when the user changes (different user appears in subsequent stories).

---

## 4. Connector-Based Layout Rules

### 4.1 Story Group Traversal
- **Story Groups**: Traversed left-to-right, top-to-bottom (same approach as stories)
- **Group Connector**: Determines how groups connect to each other
  - `connector="and"` or `null`: Horizontal connection (next group to the right)
  - `connector="or"`: Vertical connection (next group below)
  - `connector="opt"`: Optional connection (next group below, optional path)
- **Group Type**: Determines how stories are arranged within the group
  - `type="and"`: Stories arranged horizontally (left-to-right)
  - `type="or"`: Stories arranged vertically (top-to-bottom)

### 4.2 Sequential Stories (`connector="and"`)
- **Position**: Within `type="and"` story groups: horizontal flow, left-to-right by `sequential_order`
- **Y-position**: Base story row (y=337) for first group, or below for subsequent groups with `connector="or"`
- **Spacing**: 60px between story centers horizontally

### 4.3 Optional Stories (`connector="opt"`)
- **Position**: Below sequential stories
- **Y-position**: Start at y=402 (65px below base row)
- **Stacking**: Multiple optional stories stack vertically with ~55px spacing according to `sequential_order`
- **X-position**: Aligned with the sequential story they relate to, or at the end of sequential stories

**Example from graph:**
- Sequential story at sequential_order=4: y=337
- Optional story at sequential_order=4: y=402 (below)
- Optional story at sequential_order=5: y=518.75 (further below)

### 4.4 Alternative Stories (`connector="or"`)
- **Position**: Appear below sequential stories (positioned identically to `connector="opt"` stories)
- **Y-position**: Below (y=404.75, y=462, y=526.37, y=645.37)
- **Stacking**: Multiple alternative stories stack vertically with ~55px spacing according to `sequential_order`
- **X-position**: Aligned with the sequential story they relate to
- **Visual**: Indicates alternative paths in the workflow

---

## 5. Story Groups Layout

### 5.1 Story Group Positioning
- **Story Groups**: Sub-epics contain story groups, not direct stories
- **Group Connector**: Determines positioning relative to previous group
  - First group: `connector=null`, positioned at base story row (y=337)
  - `connector="and"`: Positioned horizontally to the right of previous group
  - `connector="or"`: Positioned vertically below previous group
  - `connector="opt"`: Positioned vertically below previous group (optional path)
- **Group Type**: Determines story arrangement within group
  - `type="and"`: Stories flow horizontally (left-to-right)
  - `type="or"`: Stories flow vertically (top-to-bottom)

### 5.2 Story Group Traversal
- Story groups are traversed left-to-right, top-to-bottom (same as stories)
- Process groups in order: first group at base row, subsequent groups based on `connector`
- Within each group, process stories according to group `type` and story `sequential_order`

---

## 6. User Positioning Rules

### 6.1 User Element Creation
- Extract all unique user names from story `users` arrays
- Create one user circle per unique user name
- **User Display Rule**: If there are multiple AND stories (sequential stories) with the same user, show the user circle only above the first story. Only show the user circle again when the user changes (different user appears in subsequent stories).
- Position users above the first story that uses that user (or above the first story when the user changes)

### 6.2 User Y-Position
- **Range**: y=277 to y=290
- **Alignment**: Vertically aligned with the story they interact with
- **X-position**: Aligned with story's x-position (or slightly offset for multiple users)

**Example from graph:**
- "Human" at x=30, y=277 (above story at x=32, y=337)
- "AI Chat" at x=152, y=277 (above story at x=152, y=337)
- "Bot Project" at x=715, y=290 (above story at x=715, y=406)

---

## 7. Epic Grouping

### 7.1 Epic Container
- Epics are grouped in a container element (group style)
- Container spans the width of all epics
- Container height: ~190px base (to accommodate epic + sub-epic + stories)
- **Nested Sub-Epic Height**: Container height needs to grow to accommodate nested sub-epic levels (sub-sub, sub-sub-sub, etc.). Each nested level adds additional vertical space for the nested sub-epic layers.

### 7.2 Epic Width Calculation
- Epic width = sum of all sub-epic widths + padding
- Each epic's width must accommodate all its sub-epics horizontally
- Epic width example: 520px (for "Build Agile Bots"), 1330px (for "Invoke MCP Bot Server")

---

## 8. Sub-Epic Positioning Within Epic

### 8.1 Horizontal Layout
- Sub-epics are arranged horizontally (side-by-side) within their epic
- All sub-epics in an epic share the same Y-position (y=200)
- X-position: Start at epic's x + 10px, then add sub-epic widths sequentially

### 8.2 Sub-Epic Width
- Sub-epic width = sum of story group widths + spacing + padding
- Width must accommodate all story groups horizontally (for `connector="and"` groups) and vertically (for `connector="or"` groups)
- **Important**: Always verify which story groups belong to which sub-epic before positioning
  - Check the story graph JSON hierarchy to ensure correct parent-child relationships
  - Story groups belong to the sub-epic that contains them in the JSON structure
  - Stories belong to their story group, not directly to the sub-epic
- Example: 520px (for "Generate Bot Server And Tools"), 420px (for "Init Project")

---

## 9. Story Group and Story Positioning Within Sub-Epic

### 9.1 Story Group Flow
- Story groups are traversed left-to-right, top-to-bottom
- First group: `connector=null`, positioned at base story row (y=337)
- Subsequent groups: Positioned based on `connector` (and/or/opt)
  - `connector="and"`: To the right of previous group (horizontal)
  - `connector="or"`: Below previous group (vertical)
  - `connector="opt"`: Below previous group (vertical, optional)

### 9.2 Story Flow Within Story Group
- **Type "and" groups**: Stories arranged horizontally (left-to-right) by `sequential_order`
  - Base Y-position: y=337 (or below if group has `connector="or"`)
  - X-position: Start at sub-epic's x + 12px, then add 60px per story
- **Type "or" groups**: Stories arranged vertically (top-to-bottom) by `sequential_order`
  - X-position: Aligned with group start
  - Y-position: Start at base row, then add ~55px per story vertically

### 9.3 Optional Story Stacking
- Stories with `connector="opt"` stack vertically below sequential stories
- They share the same X-position (or align with related sequential story)
- Vertical spacing: ~55-65px between optional stories

### 9.4 Alternative Story Positioning
- Stories with `connector="or"` always appear below sequential stories
- Y-position: Below sequential stories (y=404.75, y=462, y=526.37, y=645.37, etc.)
- X-position: Aligned with the sequential story they relate to

---

## 10. Acceptance Criteria Handling

### 10.1 Acceptance Criteria in Graph
- Stories can have `acceptance_criteria` array
- Each acceptance criterion has: `description`, `sequential_order`, `user`, `connector` (usually null)

### 10.2 Acceptance Criteria in Map
- Acceptance criteria are NOT directly rendered as separate visual elements in the outline view
- They are embedded in the story's information
- In exploration mode, acceptance criteria  rendered as wider boxes below stories

---

## 11. Story Type Visual Differentiation

### 11.1 User Stories (default)
- Fill: #fff2cc (yellow)
- Text: Black
- Style: Standard story style

### 11.2 System Stories
- Fill: #1a237e (dark blue)
- Text: White (#ffffff)
- Stroke: #0d47a1

### 11.3 Technical Stories
- Fill: #000000 (black)
- Text: White (#ffffff)
- Stroke: #333333

---

## 12. Implementation Algorithm

### 12.1 Processing Order
1. Process epics in `sequential_order` order
2. For each epic:
   - Create epic rectangle at y=130
   - Process sub-epics in `sequential_order` order
   - For each sub-epic:
     - Create sub-epic rectangle at y=200
     - Process story groups left-to-right, top-to-bottom
     - For each story group:
       - Determine group position based on `connector` (and/or/opt/null)
       - Process stories within group according to group `type`:
         - `type="and"`: Arrange stories horizontally (left-to-right) by `sequential_order`
         - `type="or"`: Arrange stories vertically (top-to-bottom) by `sequential_order`
       - Separate stories by connector type:
         - Sequential (`connector="and"`): Place at y=337 (or below if group has `connector="or"`)
         - Optional (`connector="opt"`): Place below at y=402+
         - Alternative (`connector="or"`): Place below at y=402+
   - Extract and position users above stories

### 12.2 Width Calculation
- Calculate epic width: Sum of sub-epic widths + spacing
- Calculate sub-epic width: Sum of story group widths + spacing + padding
  - For `type="and"` groups: Sum of story widths + spacing
  - For `type="or"` groups: Widest story (usually 50px)
- Epic width must span all its content horizontally

### 12.3 User Deduplication
- Process stories in `sequential_order` order
- Track the current user as you process stories
- Show user circle above the first story that uses a user
- If multiple AND stories have the same user, only show the user circle above the first story
- Only show the user circle again when the user changes (different user appears in subsequent stories)

---

## 13. Special Cases

### 13.1 Stories with Empty Users Array
- If `users` array is empty, no user circle is created above the story
- Story still renders normally

### 13.2 Stories with Multiple Users
- Multiple users can be associated with one story
- Each unique user gets its own circle
- Users are positioned above the story, potentially side-by-side if multiple

### 13.3 Story Groups with Different Types
- Story groups can have different `type` values (and/or) within the same sub-epic
- `type="and"` groups: Stories flow horizontally
- `type="or"` groups: Stories flow vertically
- Groups are connected based on their `connector` value (and/or/opt/null)

### 13.4 Mixed Connector Types
- A sub-epic can contain stories with different connector types
- Sequential stories form the base row
- Optional and alternative stories branch below

---

## 14. Coordinate System Reference

**Key Y-Positions:**
- Epic row: y=130
- Sub-epic row: y=200
- User row: y=277-290
- Story base row: y=337
- Optional story row: y=402+
- Story group rows (with connector="or"): y=402+, y=462+, y=526.37+, y=645.37+

**Key X-Positions:**
- Epic start: x=20
- Sub-epic start: epic x + 10
- Story start: sub-epic x + 12
- Story spacing: 60px between centers

**Element Dimensions:**
- Epic: height=60
- Sub-epic: height=70
- Story: 50x50
- User: 50x50

---

## 15. Example Mapping

### 15.1 Simple Example

**From Graph:**
```json
{
  "epics": [{
    "name": "Build Agile Bots",
    "sequential_order": 1,
    "sub_epics": [{
      "name": "Generate Bot Server And Tools",
      "sequential_order": 1,
      "story_groups": [{
        "type": "and",
        "connector": null,
        "stories": [{
          "name": "Provides Context of New Bot",
          "sequential_order": 1,
          "connector": "and",
          "users": ["Human"]
        }]
      }]
    }]
  }]
}
```

**To Map:**
- Epic "Build Agile Bots": x=20, y=130, width=520, height=60
- Sub-epic "Generate Bot Server And Tools": x=20, y=200, width=520, height=70
- Story "Provides Context of New Bot": x=32, y=337, width=50, height=50
- User "Human": x=30, y=277, width=50, height=50

### 15.2 Complex Example

**From Graph:**
```json
{
  "epics": [
    {
      "name": "Build Agile Bots",
      "sequential_order": 1,
      "sub_epics": [
        {
          "name": "Generate Bot Server And Tools",
          "sequential_order": 1,
          "story_groups": [
            {
              "type": "and",
              "connector": null,
              "stories": [
                {
                  "name": "Provides Context of New Bot",
                  "sequential_order": 1,
                  "connector": "and",
                  "users": ["Human"],
                  "story_type": "user"
                },
                {
                  "name": "Generates Project Scaffold",
                  "sequential_order": 2,
                  "connector": "and",
                  "users": ["Human"],
                  "story_type": "user"
                }
              ]
            },
            {
              "type": "and",
              "connector": "opt",
              "stories": [
                {
                  "name": "Save Project State",
                  "sequential_order": 1,
                  "connector": "opt",
                  "users": ["Bot Project"],
                  "story_type": "system"
                }
              ]
            },
            {
              "type": "and",
              "connector": "or",
              "stories": [
                {
                  "name": "Intercepts Tool Call",
                  "sequential_order": 1,
                  "connector": "or",
                  "users": ["AI Chat"],
                  "story_type": "user"
                },
                {
                  "name": "Route To Project Tool",
                  "sequential_order": 2,
                  "connector": "and",
                  "users": ["Bot Project"],
                  "story_type": "system"
                }
              ]
            }
          ]
        },
        {
          "name": "Init Project",
          "sequential_order": 2,
          "story_groups": [
            {
              "type": "and",
              "connector": null,
              "stories": [
                {
                  "name": "Create Project Structure",
                  "sequential_order": 1,
                  "connector": "and",
                  "users": ["Human"],
                  "story_type": "user"
                }
              ]
            },
            {
              "type": "and",
              "connector": "or",
              "stories": [
                {
                  "name": "Validate Configuration",
                  "sequential_order": 1,
                  "connector": "or",
                  "users": ["System"],
                  "story_type": "system"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "Invoke MCP Bot Server",
      "sequential_order": 2,
      "sub_epics": [
        {
          "name": "MCP Integration",
          "sequential_order": 1,
          "story_groups": [
            {
              "type": "and",
              "connector": null,
              "stories": [
                {
                  "name": "Connect to MCP Server",
                  "sequential_order": 1,
                  "connector": "and",
                  "users": ["Bot Server"],
                  "story_type": "technical"
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

**To Map:**
- **Epic 1 "Build Agile Bots"**: x=20, y=130, width=940, height=60
  - **Sub-epic 1 "Generate Bot Server And Tools"**: x=20, y=200, width=520, height=70
    - **Story Group 1** (type="and", connector=null): x=20, y=337, width=120, height=50
      - Story "Provides Context of New Bot": x=32, y=337, width=50, height=50 (yellow, user story)
      - Story "Generates Project Scaffold": x=92, y=337, width=50, height=50 (yellow, user story)
      - User "Human": x=30, y=277, width=50, height=50 (only above first story with Human)
    - **Story Group 2** (type="and", connector="opt"): x=152, y=402, width=50, height=50
      - Story "Save Project State": x=152, y=402, width=50, height=50 (dark blue, system story, optional)
      - User "Bot Project": x=150, y=290, width=50, height=50
    - **Story Group 3** (type="and", connector="or"): x=212, y=404.75, width=110, height=50
      - Story "Intercepts Tool Call": x=212, y=404.75, width=50, height=50 (yellow, alternative)
      - Story "Route To Project Tool": x=272, y=404.75, width=50, height=50 (dark blue, in same story group)
      - User "AI Chat": x=210, y=290, width=50, height=50
  - **Sub-epic 2 "Init Project"**: x=540, y=200, width=420, height=70
    - **Story Group 1** (type="and", connector=null): x=540, y=337, width=50, height=50
      - Story "Create Project Structure": x=552, y=337, width=50, height=50 (yellow)
      - User "Human": x=550, y=277, width=50, height=50 (shown again because user changed)
    - **Story Group 2** (type="and", connector="or"): x=612, y=404.75, width=50, height=50
      - Story "Validate Configuration": x=612, y=404.75, width=50, height=50 (dark blue, alternative)
      - User "System": x=610, y=290, width=50, height=50

- **Epic 2 "Invoke MCP Bot Server"**: x=960, y=130, width=420, height=60
  - **Sub-epic "MCP Integration"**: x=960, y=200, width=420, height=70
    - **Story Group 1** (type="and", connector=null): x=960, y=337, width=50, height=50
      - Story "Connect to MCP Server": x=972, y=337, width=50, height=50 (black, technical story)
      - User "Bot Server": x=970, y=277, width=50, height=50

**ASCII Art Visualization:**
```
y=130 ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ ┌──────────────────────────────┐
      │ Epic 1: Build Agile Bots                                                                    │ │ Epic 2: Invoke MCP Bot Server │
      └─────────────────────────────────────────────────────────────────────────────────────────────┘ └──────────────────────────────┘

y=200 ┌──────────────────────────────────────────────────────────┐ ┌──────────────────────────────────┐ ┌──────────────────────────────┐
      │ Sub-epic 1: Generate Bot Server And Tools                │ │ Sub-epic 2: Init Project         │ │ Sub-epic: MCP Integration     │
      └──────────────────────────────────────────────────────────┘ └──────────────────────────────────┘ └──────────────────────────────┘

y=277  (H)                                                                                              (H)                          (BS)
       Human                                                                                            Human                         Bot Server

y=290                                                                  (BP)  (AC)                                                      (S)
                                                                      Bot    AI Chat                                                    System
                                                                      Project

y=337  [S1]──→[S2]                                                                                    [S5]                          [S6]
       Provides Generates                                                                              Create                        Connect
       Context   Project                                                                               Project                       to MCP
       of New    Scaffold                                                                              Structure                     Server
       Bot

y=402                                                                  [S3]
                                                                      Save
                                                                      Project
                                                                      State
                                                                      (opt)

y=404.75                                                              [S4]──→[NS1]
                                                                      Intercepts Route To
                                                                      Tool     Project
                                                                      Call     Tool
                                                                      (or)     (AND in OR)
                                                                              [S7]
                                                                              Validate
                                                                              Config
                                                                              (or)

Legend:
  (H) = User circle (Human)
  (BP) = User circle (Bot Project)
  (AC) = User circle (AI Chat)
  (BS) = User circle (Bot Server)
  (S) = User circle (System)
  [S1-S7] = Story boxes (yellow=user, dark blue=system, black=technical)
  [NS1] = Nested story (AND nested in OR)
  ──→ = Horizontal flow (sequential AND stories)
  ↓ = Vertical stacking (OPT/OR stories below)
```





**Key Points Demonstrated:**
1. Multiple epics arranged horizontally
2. Multiple sub-epics within an epic
3. Story groups with different types (and/or) and connectors (and/or/opt/null)
4. Sequential AND stories flow horizontally (y=337) in type="and" groups
5. Optional story group (connector="opt") appears below (y=402)
6. Alternative story group (connector="or") appears below (y=404.75)
7. Stories within story groups arranged by group type (and=horizontal, or=vertical)
8. User "Human" shown only above first story, then again when user changes
9. Different story types: user (yellow), system (dark blue), technical (black)
10. Multiple users positioned above their stories
11. **No nested stories** - all stories are flat within story groups

---

## 16. Pattern Recognition and Visual Consistency

### 16.1 Pattern Recognition Rule

**When** adding new stories to an existing story map:

1. **Always examine previously added stories** - Review the existing layout before positioning new elements. Stories may have been positioned in ways that don't strictly conform to the standard rules but make more visual sense.

2. **Identify visual patterns** - Look for consistent patterns in:
   - Column organization (which users/agents appear in which columns)
   - Vertical flow (read → load → inject → read injected → make decisions)
   - Horizontal spacing and alignment
   - Grouping of related actions

3. **Isolate pattern variables** - When spotting a pattern:
   - **Identify the consistent parts**: What stays the same across similar story groups?
   - **Identify the variables**: What changes between similar story groups?
   - **Document the pattern**: Describe the pattern structure clearly

4. **Verify before applying** - Before rendering new stories using a detected pattern:
   - **Present the pattern** to the user with:
     - Description of the consistent structure
     - Identification of the variables
     - Proposed application to new stories
   - **Request confirmation**: Ask if the user wants you to render using this pattern
   - **Wait for approval** before applying the pattern to new elements

### 16.2 Example Pattern Recognition

**Pattern Detected:**
- Column 1 (AI Chat): Read → Load → Read Injected → Make Decisions → Read Injected → Make Decisions
- Column 2 (Bot-Behavior): Inject → Load → Inject
- Column 3 (AI Chat): Present → Pause

**Variables:**
- Story names change
- Specific actions change (Read Planning Instructions vs Read Questions)
- But the flow pattern remains consistent

**Proposed Application:**
Apply this same column structure and vertical flow to "Provide Decision Criteria and Assumptions Based On Context" stories.

**User Confirmation Required:** Should I render using this pattern?

---

## 17. Validation Rules

When constructing a story map, ensure:
1. All epics are rendered in `sequential_order`
2. All sub-epics are rendered within their epic in `sequential_order`
3. All story groups are traversed left-to-right, top-to-bottom within their sub-epic
4. Story groups are positioned based on their `connector` (and/or/opt/null)
5. Stories within groups are arranged based on group `type` (and/or) and story `sequential_order`
6. Users are positioned above stories that reference them
7. Optional stories appear below sequential stories
8. Epic width spans all sub-epics
9. Sub-epic width spans all story groups
10. No overlapping elements (except intentional grouping)
11. Visual hierarchy is clear (epics → sub-epics → story groups → stories)
12. **Pattern consistency**: When patterns are detected and confirmed, apply them consistently to similar story groups
13. **No nested stories**: Stories are flat within story groups - stories do not contain other stories
