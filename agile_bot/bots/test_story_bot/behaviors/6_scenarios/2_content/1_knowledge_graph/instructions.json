{
  "behaviorName": "specification_scenarios",
  "step": "1_knowledge_graph",
  "instructions": [
    "**CRITICAL: Story Graph Structure - Main Epics Section is Single Source of Truth**",
    "",
    "**Two-Section Architecture:**",
    "",
    "1. **Main 'epics' Section (Single Source of Truth)**",
    "   - Location: story-graph.json → 'epics' array (top-level)",
    "   - Contains ALL story details: name, users, sequential_order, story_type, connector, scenarios, scenario_outlines, Steps, acceptance_criteria, etc.",
    "   - This is the PRIMARY location - all story details must be here",
    "   - Used as the source for all views (outline, increments, discovery, exploration, scenarios)",
    "   - Structure: epics → sub_epics → story_groups → stories (with full details including scenarios and scenario_outlines)",
    "",
    "2. **'increments' Section (Minimal Reference View)**",
    "   - Location: story-graph.json → 'increments' array → increment → epics → sub_epics → stories",
    "   - This is a MINIMAL REFERENCE VIEW - just enough to know which stories belong to which increment",
    "   - Stories in increments should ONLY contain: name, users (optional), sequential_order",
    "   - NO story details (no story_type, no connector, no scenarios, no scenario_outlines, no Steps, no acceptance_criteria, etc.)",
    "   - Increments are a COPY of the outline view at the story level - just for mapping stories to increments",
    "   - All story details come from the main epics section",
    "",
    "**BUILD STORY GRAPH WITH SCENARIOS**",
    "",
    "**Input:** Existing story-graph.json from exploration stage",
    "",
    "**Output:** Updated story-graph.json with scenarios added to each story (and scenario outlines with examples if decision criteria chosen)",
    "",
    "**CRITICAL: When Adding Scenarios:**",
    "",
    "1. **Update Main Epics Section ONLY**",
    "   - Add/update scenarios and scenario_outlines in main epics → sub_epics → story_groups → stories",
    "   - Include all fields: name, users, sequential_order, story_type, connector, scenarios, scenario_outlines, Steps, acceptance_criteria, etc.",
    "",
    "2. **Do NOT Update Increments Section**",
    "   - Increments section remains minimal (name, users, sequential_order only)",
    "   - Do NOT add scenarios, scenario_outlines, or other details to increments",
    "   - Reference back to main epics section for all details",
    "",
    "**Process:**",
    "",
    "1. **Load existing story graph** from project area: docs/stories/story-graph.json",
    "",
    "2. **Check decision criteria:**",
    "   - Review planning decision criteria: agile_bot/bots/story_bot/behaviors/6_scenarios/1_guardrails/planning/decision_criteria/scenario_outline.json",
    "   - **IF decision criteria answer is 'Yes' (formulas/calculations need multiple data points OR domain has named entities OR parameter variations exist):**",
    "     * Proceed to create Scenario Outlines with Examples tables (see step 3b)",
    "   - **IF decision criteria answer is 'No' (behavior is simple/obvious and doesn't need data variations):**",
    "     * Create regular scenarios only (see step 3a)",
    "",
    "3a. **For regular scenarios (when decision criteria is 'No'):**",
    "   - Review story name, description, and acceptance criteria",
    "   - Identify common setup steps that apply across multiple scenarios (if 3+ scenarios share setup, move to Background)",
    "   - Generate scenarios covering:",
    "     * **happy_path**: Normal, expected user flow",
    "     * **edge_case**: Boundary conditions, unusual but valid inputs",
    "     * **error_case**: Invalid inputs, error conditions, validation failures",
    "   - Structure each scenario:",
    "     ```json",
    "     {",
    "       \"name\": \"Descriptive scenario name\",",
    "       \"type\": \"happy_path|edge_case|error_case\",",
    "       \"background\": [",
    "         \"Given <common_setup_step>\",",
    "         \"And <another_common_setup>\"",
    "       ],",
    "       \"steps\": [",
    "         \"Given <scenario_specific_state>\",",
    "         \"When <user_action_or_system_event>\",",
    "         \"Then <expected_outcome>\"",
    "       ]",
    "     }",
    "     ```",
    "",
    "3b. **For Scenario Outlines with Examples (ONLY when decision criteria is 'Yes'):**",
    "   - Review existing scenarios from specification_scenarios stage",
    "   - Identify scenarios that need data variation:",
    "     * Scenarios testing formulas or calculations with different inputs",
    "     * Scenarios testing domain entities with different property values",
    "     * Scenarios testing parameter variations (boundaries, edge cases)",
    "     * Scenarios that need multiple test data combinations",
    "   - Convert appropriate scenarios to Scenario Outlines",
    "   - Structure each Scenario Outline:",
    "     ```json",
    "     {",
    "       \"name\": \"Descriptive scenario outline name\",",
    "       \"type\": \"happy_path|edge_case|error_case\",",
    "       \"background\": [",
    "         \"Given <common_setup_step>\",",
    "         \"And <another_common_setup>\"",
    "       ],",
    "       \"steps\": [",
    "         \"Given <setup> at \\\"<variable_path>\\\"\",",
    "         \"When <action> with <param>=\\\"<variable_value>\\\"\",",
    "         \"Then <outcome> equals \\\"<expected_result>\\\"\"",
    "       ],",
    "       \"examples\": {",
    "         \"columns\": [\"variable_path\", \"variable_value\", \"expected_result\"],",
    "         \"rows\": [",
    "           [\"value1\", \"value2\", \"result1\"],",
    "           [\"value3\", \"value4\", \"result2\"]",
    "         ]",
    "       }",
    "     }",
    "     ```",
    "   - **Examples Table Requirements (CRITICAL):**",
    "     * EVERY variable in Steps (e.g., <variable_name>) MUST have a column in Examples",
    "     * Include BOTH input variables AND output/expected result variables",
    "     * Every cell MUST have exact test data values (NO placeholders, NO empty cells)",
    "     * Must have at least 2 rows of test data",
    "     * Use realistic, concrete test data values",
    "",
    "4. **Use Gherkin best practices:**",
    "   - Use plain English (no variables in regular scenarios, variables in angle brackets for Scenario Outlines)",
    "   - Be specific and concrete",
    "   - Focus on user behavior and outcomes",
    "   - Use 'Given' for state/setup, 'When' for action/event, 'Then' for expected outcome",
    "   - Use 'And' to continue from previous step type",
    "   - For Scenario Outlines: Variables in angle brackets: <variable_name>, Variables in steps must be quoted: \\\"<variable_name>\\\"",
    "",
    "5. **Save updated story graph** to project area: docs/stories/story-graph.json",
    "",
    "**Template:** story-graph-scenarios.json (for regular scenarios), story-graph-examples.json (for Scenario Outlines with Examples)",
    "",
    "**Validation:**",
    "- Each story has at least 1 happy_path scenario",
    "- Edge cases and error cases are included where relevant",
    "- Background steps are only used when shared by 3+ scenarios",
    "- All steps use proper Gherkin format (Given/When/Then/And)",
    "- **IF Scenario Outlines are used (decision criteria = 'Yes'):**",
    "  * Only scenarios needing data variation are converted to Scenario Outlines",
    "  * All variables in Steps have matching columns in Examples table",
    "  * Examples tables include both inputs and expected outputs",
    "  * All Examples cells contain concrete test data (no placeholders)",
    "  * At least 2 rows of test data per Scenario Outline"
  ]
}


