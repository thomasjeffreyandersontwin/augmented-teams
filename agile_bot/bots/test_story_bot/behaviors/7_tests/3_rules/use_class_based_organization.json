{
  "description": "Use class-based organization with pytest orchestrator pattern. Test classes match story names exactly (Test<ExactStoryName>), test methods match scenario names exactly (test_<scenario_name_snake_case>). Helper functions/fixtures provide reusable operations. Keep tests under 20 lines, helpers under 20 lines, classes under 300 lines.",
  "rationale": [
    "Class-based organization groups related scenarios by story, making it easy to find all tests for a specific story",
    "Test classes named after stories provide 1-to-1 traceability with story map",
    "Test methods named after scenarios provide 1-to-1 traceability with story scenarios",
    "Orchestrator pattern keeps test methods readable and focused on flow, not implementation details",
    "Helper functions extract complex setup, keeping tests under 20 lines and readable",
    "File structure mirrors story map hierarchy: sub-epic → file, story → class, scenario → method"
  ],
  "examples": [
    {
      "do": {
        "description": "Class matches story name exactly, methods match scenario names exactly",
        "content": [
          "# File: test_generate_bot_server_and_tools.py",
          "# Sub-epic: Generate Bot Server And Tools",
          "",
          "# ============================================================================",
          "# HELPER FUNCTIONS - Reusable operations (under 20 lines each)",
          "# ============================================================================",
          "",
          "def create_bot_config(workspace: Path, bot_name: str) -> Path:",
          "    \"\"\"Helper: Create bot configuration file.\"\"\"",
          "    config_path = workspace / 'bots' / bot_name / 'config.json'",
          "    config_path.parent.mkdir(parents=True, exist_ok=True)",
          "    config_path.write_text(json.dumps({'name': bot_name}))",
          "    return config_path",
          "",
          "# ============================================================================",
          "# STORY: Generate Bot Tools",
          "# ============================================================================",
          "",
          "class TestGenerateBotTools:",
          "    \"\"\"Story: Generate Bot Tools - Tests bot tool generation.\"\"\"",
          "    ",
          "    def test_generator_creates_bot_tool_for_test_bot(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Generator creates bot tool for test_bot",
          "        GIVEN: Bot configuration exists",
          "        WHEN: Generator processes Bot Config",
          "        THEN: Generator creates bot tool instance",
          "        \"\"\"",
          "        # Given: Bot config exists",
          "        bot_config = create_bot_config(workspace_root, 'test_bot')",
          "        ",
          "        # When: Call REAL Generator API",
          "        from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "        generator = ToolGenerator(bot_name='test_bot', config_path=bot_config, workspace_root=workspace_root)",
          "        tool = generator.generate_bot_tool()",
          "        ",
          "        # Then: Tool created",
          "        assert tool.name == 'test_bot_bot'",
          "",
          "    def test_generator_creates_tool_with_correct_parameters(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Generator creates tool with correct parameters",
          "        GIVEN: Bot configuration exists",
          "        WHEN: Generator processes Bot Config",
          "        THEN: Tool has correct behavior and action parameters",
          "        \"\"\"",
          "        # Given: Bot config exists",
          "        bot_config = create_bot_config(workspace_root, 'test_bot')",
          "        ",
          "        # When: Generate tool",
          "        from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "        generator = ToolGenerator(bot_name='test_bot', config_path=bot_config, workspace_root=workspace_root)",
          "        tool = generator.generate_bot_tool()",
          "        ",
          "        # Then: Tool has correct parameters",
          "        assert 'bot_name' in tool.parameters",
          "        assert tool.parameters['bot_name'] == 'test_bot'",
          "",
          "# ============================================================================",
          "# STORY: Generate Behavior Tools",
          "# ============================================================================",
          "",
          "class TestGenerateBehaviorTools:",
          "    \"\"\"Story: Generate Behavior Tools - Tests behavior tool generation.\"\"\"",
          "    ",
          "    def test_generator_creates_behavior_tool_for_each_behavior(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Generator creates behavior tool for each behavior",
          "        GIVEN: Bot has multiple behaviors",
          "        WHEN: Generator processes Bot Config",
          "        THEN: Generator creates one tool per behavior",
          "        \"\"\"",
          "        # Given: Bot with behaviors",
          "        bot_config = create_bot_config(workspace_root, 'test_bot', behaviors=['shape', 'discovery'])",
          "        ",
          "        # When: Generate tools",
          "        from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "        generator = ToolGenerator(bot_name='test_bot', config_path=bot_config, workspace_root=workspace_root)",
          "        tools = generator.generate_behavior_tools()",
          "        ",
          "        # Then: Tools created",
          "        assert len(tools) == 2",
          "        assert any(tool.name == 'test_bot_shape' for tool in tools)",
          "        assert any(tool.name == 'test_bot_discovery' for tool in tools)"
        ]
      },
      "dont": {
        "description": "Generic class names or abbreviated method names",
        "content": [
          "# DON'T: Generic class names not matching story",
          "class TestToolGeneration:  # WRONG - story is 'Generate Bot Tools'",
          "    \"\"\"Generic name - which story is this?\"\"\"",
          "    pass",
          "",
          "# DON'T: Abbreviated class names",
          "class TestGenBotTools:  # WRONG - story is 'Generate Bot Tools'",
          "    pass",
          "",
          "# DON'T: Abbreviated method names",
          "def test_creates_tool(self):  # WRONG - scenario is 'Generator creates bot tool for test_bot'",
          "    pass",
          "",
          "# DON'T: Generic method names",
          "def test_tool_generation(self):  # WRONG - doesn't match scenario name",
          "    pass",
          "",
          "# DON'T: Numbered scenarios",
          "def test_scenario_1(self):  # WRONG - not descriptive, doesn't match scenario",
          "    pass",
          "",
          "# DON'T: Tests over 20 lines (extract to helpers)",
          "def test_generator_creates_bot_tool(self, workspace_root):",
          "    # Given: 10 lines of complex setup...",
          "    # When: 5 lines of action...",
          "    # Then: 10 lines of verification...",
          "    # WRONG: Extract setup to helper function!"
        ]
      }
    },
    {
      "do": {
        "description": "File structure mirrors story map hierarchy",
        "content": [
          "# Story Map Structure:",
          "# Epic: Build Agile Bots",
          "#   Sub-epic: Generate Bot Server And Tools",
          "#     Story: Generate Bot Tools",
          "#       Scenario: Generator creates bot tool for test_bot",
          "#       Scenario: Generator creates tool with correct parameters",
          "#     Story: Generate Behavior Tools",
          "#       Scenario: Generator creates behavior tool for each behavior",
          "",
          "# Test File Structure:",
          "# File: test_generate_bot_server_and_tools.py  (matches sub-epic)",
          "#   class TestGenerateBotTools:  (matches story exactly)",
          "#     def test_generator_creates_bot_tool_for_test_bot(...):  (matches scenario exactly)",
          "#     def test_generator_creates_tool_with_correct_parameters(...):  (matches scenario exactly)",
          "#   class TestGenerateBehaviorTools:  (matches story exactly)",
          "#     def test_generator_creates_behavior_tool_for_each_behavior(...):  (matches scenario exactly)",
          "",
          "# GOOD: Clear 1-to-1 mapping:",
          "# - Sub-epic → test file",
          "# - Story → test class (EXACT name match)",
          "# - Scenario → test method (EXACT name match)"
        ]
      },
      "dont": {
        "description": "Unclear mapping or inconsistent structure",
        "content": [
          "# BAD: Inconsistent naming",
          "# File: test_bot_tools.py  (doesn't match sub-epic 'Generate Bot Server And Tools')",
          "#   class TestToolGen:  (doesn't match story 'Generate Bot Tools')",
          "#     def test_creates_tool(self):  (doesn't match scenario 'Generator creates bot tool for test_bot')",
          "",
          "# BAD: Multiple stories in wrong order",
          "#   class TestGenerateBehaviorTools:  (should be second)",
          "#   class TestGenerateBotTools:  (should be first)",
          "",
          "# WRONG: Can't easily map back to story map!"
        ]
      }
    },
    {
      "do": {
        "description": "Helper functions keep tests under 20 lines",
        "content": [
          "# Helper function (under 20 lines)",
          "def create_bot_with_behaviors(workspace_root: Path, bot_name: str, behaviors: list) -> tuple[Path, Bot]:",
          "    \"\"\"Helper: Create bot configuration with behaviors and return bot instance.\"\"\"",
          "    config_path = workspace_root / 'bots' / bot_name / 'config.json'",
          "    config_path.parent.mkdir(parents=True, exist_ok=True)",
          "    config = {'name': bot_name, 'behaviors': behaviors}",
          "    config_path.write_text(json.dumps(config))",
          "    ",
          "    from agile_bot.bots.base_bot.src.bot.bot import Bot",
          "    bot = Bot(bot_name=bot_name, workspace_root=workspace_root, config_path=config_path)",
          "    return config_path, bot",
          "",
          "# Test method (under 20 lines)",
          "def test_generator_creates_bot_tool_for_test_bot(self, workspace_root):",
          "    \"\"\"",
          "    SCENARIO: Generator creates bot tool for test_bot",
          "    GIVEN: Bot configuration exists",
          "    WHEN: Generator processes Bot Config",
          "    THEN: Generator creates bot tool instance",
          "    \"\"\"",
          "    # Given: Bot config exists (using helper)",
          "    config_path, bot = create_bot_with_behaviors(workspace_root, 'test_bot', ['shape'])",
          "    ",
          "    # When: Generate tool",
          "    from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "    generator = ToolGenerator(bot_name='test_bot', config_path=config_path, workspace_root=workspace_root)",
          "    tool = generator.generate_bot_tool()",
          "    ",
          "    # Then: Tool created",
          "    assert tool.name == 'test_bot_bot'"
        ]
      },
      "dont": {
        "description": "Long test methods with inline complex setup",
        "content": [
          "# DON'T: Test method over 20 lines",
          "def test_generator_creates_bot_tool(self, workspace_root):",
          "    # Given: Complex setup inline (10+ lines)",
          "    workspace = workspace_root / 'workspace'",
          "    workspace.mkdir()",
          "    bots_dir = workspace / 'bots'",
          "    bots_dir.mkdir()",
          "    bot_dir = bots_dir / 'test_bot'",
          "    bot_dir.mkdir()",
          "    config_dir = bot_dir / 'config'",
          "    config_dir.mkdir()",
          "    config_file = config_dir / 'bot_config.json'",
          "    config = {'name': 'test_bot', 'behaviors': ['shape']}",
          "    config_file.write_text(json.dumps(config))",
          "    # ... more setup ...",
          "    ",
          "    # When: Action (5 lines)",
          "    # ...",
          "    ",
          "    # Then: Verification (10+ lines)",
          "    # ...",
          "    ",
          "    # WRONG: Extract setup to helper function!"
        ]
      }
    },
    {
      "do": {
        "description": "Test classes ordered by story map sequence",
        "content": [
          "# Story Map Order:",
          "# 1. Generate Bot Tools",
          "# 2. Generate Behavior Tools",
          "# 3. Generate MCP Bot Server",
          "",
          "# Test File Order (matches story map):",
          "class TestGenerateBotTools:  # First story",
          "    \"\"\"Story: Generate Bot Tools\"\"\"",
          "    pass",
          "",
          "class TestGenerateBehaviorTools:  # Second story",
          "    \"\"\"Story: Generate Behavior Tools\"\"\"",
          "    pass",
          "",
          "class TestGenerateMCPBotServer:  # Third story",
          "    \"\"\"Story: Generate MCP Bot Server\"\"\"",
          "    pass",
          "",
          "# GOOD: File reads like story map!"
        ]
      },
      "dont": {
        "description": "Test classes out of order",
        "content": [
          "# DON'T: Classes out of story map order",
          "class TestGenerateMCPBotServer:  # Should be third, not first!",
          "    pass",
          "",
          "class TestGenerateBotTools:  # Should be first!",
          "    pass",
          "",
          "class TestGenerateBehaviorTools:  # Should be second!",
          "    pass",
          "",
          "# WRONG: Can't follow story map order!"
        ]
      }
    }
  ],
  "key_principles": [
    "Test class name = EXACT story name in PascalCase: Test<ExactStoryName>",
    "Test method name = EXACT scenario name in snake_case: test_<scenario_name_snake_case>",
    "Test classes appear in same order as stories in story map",
    "One test class per story (exact 1-to-1 mapping)",
    "One test method per scenario (exact 1-to-1 mapping)",
    "Test methods under 20 lines (extract complex setup to helpers)",
    "Helper functions under 20 lines each",
    "Test classes under 300 lines (split if too large)",
    "Use orchestrator pattern: test methods show flow, helpers handle details",
    "File structure mirrors story map: sub-epic → file, story → class, scenario → method"
  ],
  "antipatterns": [
    "Generic class names not matching story names (TestToolGeneration vs TestGenerateBotTools)",
    "Abbreviated class names (TestGenBotTools vs TestGenerateBotTools)",
    "Abbreviated method names (test_creates_tool vs test_generator_creates_bot_tool_for_test_bot)",
    "Generic method names (test_tool_generation vs test_generator_creates_bot_tool_for_test_bot)",
    "Numbered scenarios (test_scenario_1 vs test_generator_creates_bot_tool_for_test_bot)",
    "Test methods over 20 lines (extract setup to helpers)",
    "Helper functions over 20 lines (split into smaller helpers)",
    "Test classes over 300 lines (split into multiple classes or files)",
    "Test classes out of story map order",
    "Unclear mapping between story map and test structure"
  ]
}
