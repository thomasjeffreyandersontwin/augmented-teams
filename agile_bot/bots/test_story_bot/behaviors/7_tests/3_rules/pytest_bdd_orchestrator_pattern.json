{
  "description": "MASTER RULE: Use pytest with orchestrator pattern for BDD-style tests. NO FEATURE FILES. Test classes contain orchestrator methods (under 20 lines) that show Given-When-Then flow by calling helper functions. Production code follows clean code principles: single responsibility, explicit dependencies, small functions. Tests drive production code through RED-GREEN-REFACTOR cycle.",
  "principles": [
    "1. Orchestrator Pattern: Test methods show flow, delegate to helpers",
    "2. Given-When-Then Structure: Clear sections with comments in each test",
    "3. Small Functions: Tests under 20 lines, helpers under 20 lines, classes under 300 lines",
    "4. Test Observable Behavior: Verify public API, not implementation details",
    "5. Real Implementations: Use real code with temp files, only mock external boundaries",
    "6. Explicit Dependencies: Constructor injection in production code",
    "7. Single Responsibility: Each function does one thing",
    "8. Test-Driven Development: RED-GREEN-REFACTOR cycle"
  ],
  "examples": [
    {
      "description": "Complete example with all principles",
      "content": [
        "\"\"\"",
        "Agent Configuration Tests",
        "",
        "Tests follow orchestrator pattern:",
        "- Test methods show Given-When-Then flow (under 20 lines)",
        "- Helper functions provide reusable operations (under 20 lines)",
        "- Tests verify observable behavior through public API",
        "- Production code uses explicit dependencies and single responsibility",
        "\"\"\"",
        "import pytest",
        "from pathlib import Path",
        "import json",
        "",
        "# ============================================================================",
        "# HELPER FUNCTIONS - Reusable test operations",
        "# ============================================================================",
        "",
        "def create_config_file(workspace: Path, agent_name: str) -> Path:",
        "    \"\"\"Helper: Create configuration file with agent name.\"\"\"",
        "    config_dir = workspace / 'agents' / 'base'",
        "    config_dir.mkdir(parents=True, exist_ok=True)",
        "    config_file = config_dir / 'agent.json'",
        "    config_file.write_text(json.dumps({'name': agent_name}))",
        "    return config_file",
        "",
        "def create_domain_graph_file(workspace: Path, nodes: list) -> Path:",
        "    \"\"\"Helper: Create domain graph file with nodes.\"\"\"",
        "    graph_file = workspace / 'domain_graph.json'",
        "    graph_file.write_text(json.dumps({'nodes': nodes}))",
        "    return graph_file",
        "",
        "def verify_agent_configured(agent, expected_name: str, expected_workspace: Path):",
        "    \"\"\"Helper: Verify agent is correctly configured.\"\"\"",
        "    assert agent.name == expected_name",
        "    assert agent.workspace_root == expected_workspace",
        "    assert agent.is_initialized",
        "",
        "# ============================================================================",
        "# FIXTURES - Test setup",
        "# ============================================================================",
        "",
        "@pytest.fixture",
        "def workspace_root(tmp_path):",
        "    \"\"\"Fixture: Temporary workspace directory.\"\"\"",
        "    workspace = tmp_path / 'workspace'",
        "    workspace.mkdir()",
        "    return workspace",
        "",
        "@pytest.fixture",
        "def config_loader():",
        "    \"\"\"Fixture: Configuration loader for tests.\"\"\"",
        "    return ConfigLoader()",
        "",
        "@pytest.fixture",
        "def domain_graph():",
        "    \"\"\"Fixture: Domain graph for tests.\"\"\"",
        "    return DomainGraph()",
        "",
        "# ============================================================================",
        "# ORCHESTRATOR TESTS - Test flows with Given-When-Then",
        "# ============================================================================",
        "",
        "class TestAgentInitialization:",
        "    \"\"\"Agent initialization behavior tests.\"\"\"",
        "    ",
        "    def test_agent_initializes_with_base_config(self, workspace_root, config_loader, domain_graph):",
        "        \"\"\"",
        "        SCENARIO: Agent initializes with base configuration",
        "        GIVEN: Base configuration file exists",
        "        WHEN: Agent is initialized with agent_name='story_bot'",
        "        THEN: Agent loads configuration and is ready",
        "        \"\"\"",
        "        # Given: Configuration file exists",
        "        config_file = create_config_file(workspace_root, 'story_bot')",
        "        ",
        "        # When: Agent is initialized with dependencies",
        "        agent = Agent(",
        "            agent_name='story_bot',",
        "            workspace_root=workspace_root,",
        "            config_loader=config_loader,",
        "            domain_graph=domain_graph",
        "        )",
        "        agent.initialize()",
        "        ",
        "        # Then: Agent is correctly configured",
        "        verify_agent_configured(agent, 'story_bot', workspace_root)",
        "        assert agent.config_path == config_file",
        "    ",
        "    def test_agent_loads_domain_graph_when_initialized(self, workspace_root, config_loader, domain_graph):",
        "        \"\"\"",
        "        SCENARIO: Agent loads domain graph during initialization",
        "        GIVEN: Domain graph file exists with nodes",
        "        WHEN: Agent initializes",
        "        THEN: Agent has loaded domain graph with nodes",
        "        \"\"\"",
        "        # Given: Domain graph file exists",
        "        graph_file = create_domain_graph_file(workspace_root, ['node1', 'node2'])",
        "        config_file = create_config_file(workspace_root, 'story_bot')",
        "        ",
        "        # When: Agent initializes and loads graph",
        "        agent = Agent('story_bot', workspace_root, config_loader, domain_graph)",
        "        agent.initialize()",
        "        agent.load_domain_graph(graph_file)",
        "        ",
        "        # Then: Domain graph is loaded (test through public API)",
        "        assert agent.has_domain_graph",
        "        assert agent.get_domain_nodes() == ['node1', 'node2']",
        "",
        "class TestAgentConfigValidation:",
        "    \"\"\"Agent configuration validation behavior tests.\"\"\"",
        "    ",
        "    def test_agent_raises_error_when_config_missing(self, workspace_root, config_loader, domain_graph):",
        "        \"\"\"",
        "        SCENARIO: Agent raises error when configuration missing",
        "        GIVEN: No configuration file exists",
        "        WHEN: Agent attempts to initialize",
        "        THEN: Agent raises FileNotFoundError",
        "        \"\"\"",
        "        # Given: No config file (workspace is empty)",
        "        ",
        "        # When/Then: Initializing raises error",
        "        agent = Agent('story_bot', workspace_root, config_loader, domain_graph)",
        "        with pytest.raises(FileNotFoundError, match='Configuration not found'):",
        "            agent.initialize()",
        "",
        "# ============================================================================",
        "# PRODUCTION CODE - Following clean code principles",
        "# ============================================================================",
        "",
        "class Agent:",
        "    \"\"\"",
        "    Agent with configuration and domain graph support.",
        "    ",
        "    Follows clean code principles:",
        "    - Explicit dependencies through constructor injection",
        "    - Single responsibility per method",
        "    - Small methods under 20 lines",
        "    - Public API for testable behavior",
        "    \"\"\"",
        "    ",
        "    def __init__(",
        "        self,",
        "        agent_name: str,",
        "        workspace_root: Path,",
        "        config_loader: ConfigLoader,",
        "        domain_graph: DomainGraph",
        "    ):",
        "        \"\"\"Initialize agent with explicit dependencies.\"\"\"",
        "        self.name = agent_name",
        "        self.workspace_root = workspace_root",
        "        self._config_loader = config_loader",
        "        self._domain_graph = domain_graph",
        "        self._initialized = False",
        "        self._config_path = None",
        "    ",
        "    # Public API - Testable behavior",
        "    ",
        "    def initialize(self):",
        "        \"\"\"Initialize agent from configuration.\"\"\"",
        "        self._config_path = self._resolve_config_path()",
        "        config = self._config_loader.load(self._config_path)",
        "        self._validate_config(config)",
        "        self._initialized = True",
        "    ",
        "    def load_domain_graph(self, graph_path: Path):",
        "        \"\"\"Load domain graph from file.\"\"\"",
        "        self._domain_graph.load_from_file(graph_path)",
        "    ",
        "    @property",
        "    def is_initialized(self) -> bool:",
        "        \"\"\"Check if agent is initialized.\"\"\"",
        "        return self._initialized",
        "    ",
        "    @property",
        "    def config_path(self) -> Path:",
        "        \"\"\"Get agent configuration path.\"\"\"",
        "        return self._config_path",
        "    ",
        "    @property",
        "    def has_domain_graph(self) -> bool:",
        "        \"\"\"Check if domain graph is loaded.\"\"\"",
        "        return self._domain_graph.is_loaded",
        "    ",
        "    def get_domain_nodes(self) -> list:",
        "        \"\"\"Get list of domain nodes.\"\"\"",
        "        return self._domain_graph.get_nodes()",
        "    ",
        "    # Private helpers - Single responsibility",
        "    ",
        "    def _resolve_config_path(self) -> Path:",
        "        \"\"\"Resolve configuration file path.\"\"\"",
        "        config_path = self.workspace_root / 'agents' / 'base' / 'agent.json'",
        "        if not config_path.exists():",
        "            raise FileNotFoundError(f'Configuration not found: {config_path}')",
        "        return config_path",
        "    ",
        "    def _validate_config(self, config: dict):",
        "        \"\"\"Validate configuration structure.\"\"\"",
        "        if 'name' not in config:",
        "            raise ValueError('Configuration missing required field: name')",
        "",
        "# ============================================================================",
        "# KEY PRINCIPLES DEMONSTRATED:",
        "#",
        "# 1. Orchestrator Pattern:",
        "#    - test_agent_initializes_with_base_config shows flow (15 lines)",
        "#    - Delegates to create_config_file, verify_agent_configured helpers",
        "#",
        "# 2. Given-When-Then Structure:",
        "#    - Each test has clear Given/When/Then sections with comments",
        "#",
        "# 3. Small Functions:",
        "#    - All test methods under 20 lines",
        "#    - All helpers under 15 lines",
        "#    - Production methods under 10 lines each",
        "#",
        "# 4. Test Observable Behavior:",
        "#    - Tests use public API: is_initialized, config_path, get_domain_nodes()",
        "#    - No assertions on _initialized, _config_path (private)",
        "#",
        "# 5. Real Implementations:",
        "#    - Uses real files with tmp_path fixture",
        "#    - No mocking of business logic",
        "#",
        "# 6. Explicit Dependencies:",
        "#    - Agent constructor takes config_loader, domain_graph",
        "#    - Tests inject test doubles easily",
        "#",
        "# 7. Single Responsibility:",
        "#    - initialize() does initialization",
        "#    - load_domain_graph() loads graph",
        "#    - _resolve_config_path() resolves path",
        "#    - Each method does ONE thing",
        "#",
        "# 8. Test-Driven Development:",
        "#    - Write test first (RED)",
        "#    - Implement minimal code (GREEN)",
        "#    - Refactor while tests stay green (REFACTOR)",
        "# ============================================================================"
      ]
    }
  ]
}


