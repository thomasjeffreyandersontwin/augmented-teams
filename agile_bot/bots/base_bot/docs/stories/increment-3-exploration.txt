INCREMENT 3: Workflow

Business Outcome: Enable seamless transition from one stage to the next, allowing users to automatically pick up work at any stage without having to remember where they left off, with full auditing of what happened in the past.

(E) Build Agile Bots
    (F) Generate Bot Server And Tools
        (S) MCP Server Generator --> Generate Bot Tools
            (AC) WHEN MCP Server Generator scans base_actions/ folder
            (AC) THEN Generator discovers actions by reading each action folder
            (AC) AND Generator reads action_config.json from each action folder
            (AC) AND action_config.json specifies: name, workflow (true/false), order, next_action
            (AC) AND Generator creates tools for all discovered actions
            (AC) AND Tools include workflow state awareness based on action_config.workflow flag
        and
        (S) MCP Server Generator --> Generate Behavior Tools
            (AC) WHEN Generator enumerates behaviors from Bot Config
            (AC) THEN Generator creates behavior-specific tools for each action in base_actions/
            (AC) AND Generator loads action_config.json from each action folder
            (AC) AND Workflow actions (workflow: true) get automatic transition logic using next_action field
            (AC) AND Independent actions (workflow: false) get no automatic transition logic
            (AC) AND Each behavior tool knows action sequence from ordered action_config.json files

(E) Invoke MCP Bot Server
    (F) Invoke Bot Tool

        
        (S) Router --> Forward To Current Action
            (AC) WHEN Router receives behavior tool invocation
            (AC) THEN Router loads Workflow State from persistent storage
            (AC) AND Router extracts current_behavior and current_action from state
            (AC) AND Router forwards call to Bot.Behavior[current_behavior].Action[current_action]
            (AC) AND Forwarding ensures user resumes at exact point they left off
            (AC) AND If workflow state file doesn't exist, defaults to first behavior/first action
    (F) Perform Behavior Action
        (S) Base Action --> Inject Next Behavior-Action to Instructions
            (AC) WHEN Workflow action completes execution successfully (workflow: true in action_config.json)
            (AC) THEN Action loads its action_config.json and reads next_action field
            (AC) WHEN next_action is not null
            (AC) THEN Action injects instructions: "When done, proceed to [next_action_name]"
            (AC) WHEN next_action is null
            (AC) THEN Action indicates workflow is complete
            (AC) WHEN action is independent (workflow: false)
            (AC) THEN Action does NOT inject next action instructions
            (AC) AND User doesn't need to remember workflow sequence
        and
        (S) Bot Behavior --> Saves Behavior State
            (AC) WHEN Action execution starts
            (AC) THEN Behavior updates Workflow State with current_behavior, current_action, and action_state="started"
            (AC) WHEN Action execution completes
            (AC) THEN Behavior updates Workflow State with action_state="completed"
            (AC) AND State persisted to {project_area}/workflow_state.json file
            (AC) AND State includes timestamp of last action execution
            (AC) AND State includes action_state (started, completed)
            (AC) AND State includes completed_actions list showing full history with timestamps and states
            (AC) AND State includes current_behavior name
            (AC) AND State includes current_action name
            (AC) AND Persistence ensures workflow can be resumed after interruption (crash, close chat, etc.)
            (AC) AND On resume, if action_state="started", user can choose to retry or continue from that action

(E) Execute Behavior Actions
    (F) Gather Context
        (S) GatherContextAction --> Track Activity for Gather Context Action
            (AC) WHEN GatherContextAction executes
            (AC) THEN Action tracks activity (per "Track Activity for Action Execution" story in Perform Behavior Action feature)
        and
        (S) GatherContextAction --> Proceed To Decide Planning
            (AC) WHEN GatherContextAction completes execution
            (AC) AND Human says action is done
            (AC) THEN GatherContextAction saves Workflow State (per "Saves Behavior State" story)
            (AC) AND Workflow injects next action instructions (per "Inject Next Behavior-Action" story)
            (AC) AND Workflow proceeds to decide_planning_criteria
    (F) Decide Planning Criteria
        (S) PlanningAction --> Track Activity for Planning Action
            (AC) WHEN PlanningAction executes
            (AC) THEN Action tracks activity (per "Track Activity for Action Execution" story in Perform Behavior Action feature)
        and
        (S) PlanningAction --> Proceed To Build Knowledge
            (AC) WHEN PlanningAction completes execution
            (AC) AND Human says action is done
            (AC) THEN PlanningAction saves Workflow State (per "Saves Behavior State" story)
            (AC) AND Workflow injects next action instructions (per "Inject Next Behavior-Action" story)
            (AC) AND Workflow proceeds to build_knowledge
    (F) Build Knowledge
        (S) BuildKnowledgeAction --> Track Activity for Build Knowledge Action
            (AC) WHEN BuildKnowledgeAction executes
            (AC) THEN Action tracks activity (per "Track Activity for Action Execution" story in Perform Behavior Action feature)
        and
        (S) BuildKnowledgeAction --> Proceed To Render Output
            (AC) WHEN BuildKnowledgeAction completes execution
            (AC) THEN BuildKnowledgeAction saves Workflow State (per "Saves Behavior State" story)
            (AC) AND BuildKnowledgeAction submits content for saving
            (AC) AND Workflow automatically proceeds to render_output (auto_progress: true, no human confirmation needed)
    (F) Render Output
        (S) RenderOutputAction --> Track Activity for Render Output Action
            (AC) WHEN RenderOutputAction executes
            (AC) THEN Action tracks activity (per "Track Activity for Action Execution" story in Perform Behavior Action feature)
        and
        (S) RenderOutputAction --> Proceed To Validate Rules
            (AC) WHEN RenderOutputAction completes execution
            (AC) AND Human says action is done
            (AC) THEN RenderOutputAction saves Workflow State (per "Saves Behavior State" story)
            (AC) AND RenderOutputAction submits content for saving
            (AC) AND Workflow injects next action instructions (per "Inject Next Behavior-Action" story)
            (AC) AND Workflow proceeds to validate_rules
    (F) Validate Knowledge & Content Against Rules
        (S) ValidateRulesAction --> Track Activity for Validate Rules Action
            (AC) WHEN ValidateRulesAction executes
            (AC) THEN Action tracks activity (per "Track Activity for Action Execution" story in Perform Behavior Action feature)
        and
        (S) ValidateRulesAction --> Complete Validate Rules Action
            (AC) WHEN ValidateRulesAction completes execution
            (AC) THEN Action presents validation results to user
            (AC) AND Human says action is done
            (AC) THEN ValidateRulesAction saves Workflow State (per "Saves Behavior State" story)
            (AC) AND validate_rules is terminal action (next_action: null, workflow completes)

Domain Concepts (Increment Level):

Core Concepts:
- Action Configuration: Each action folder contains action_config.json specifying: name, workflow (true/false), order, next_action, optional auto_progress
- Workflow Action: Action with workflow: true. Has order number, next_action defined, triggers automatic transitions
- Independent Action: Action with workflow: false (e.g., correct_bot). No order, no next_action, invoked independently by user
- Workflow State: Tracks current_behavior, current_action, action_state (started/completed), completed_actions, timestamp
- Action Execution State: Tracks whether action is "started" or "completed", enables detection of interrupted workflows
- Activity Log: Audit trail of all action executions with timestamps, inputs, outputs, and results
- Router: Routes MCP tool calls to current behavior/action based on Workflow State
- State Persistence: Saves workflow state after every action to enable resumption at any point
- Action Discovery: Generator scans base_actions/ folder and reads action_config.json from each folder

Domain Behaviors:
- Seamless Transition: System automatically determines next action without user needing to remember workflow sequence
- Auto Resume: User can pick up work at exact point they left off by loading Workflow State from persistent storage
- Audit Trail: Complete history of what happened (actions executed, content generated, validations performed, timestamps)
- Sequential Flow: Actions execute in defined sequence within each behavior
- State-Based Routing: Router uses Workflow State to forward to current behavior/action, not hardcoded default behavior
- Automatic Next Step Injection: Each action completion injects explicit instructions about next step into AI context

Domain Rules:
- Each action folder MUST contain action_config.json with: name, workflow, order, next_action
- Generator MUST read action_config.json from each action folder to determine action type
- Workflow actions (workflow: true) MUST have order and can have next_action
- Independent actions (workflow: false) MUST have workflow: false, order: null, next_action: null
- Workflow State MUST be persisted when action starts (action_state="started") and when action completes (action_state="completed")
- Router MUST check Workflow State before routing to behavior/action
- Activity Log MUST record every action execution with timestamp
- Next action instructions MUST be injected automatically ONLY for workflow actions where next_action is not null
- Independent actions do NOT inject next action instructions
- State file location: {project_area}/workflow_state.json
- Activity log location: {project_area}/activity_log.json
- Action config location: base_actions/{action_name}/action_config.json
- If workflow_state.json doesn't exist, default to first behavior's first action
- Workflow State must include: current_behavior, current_action, action_state, completed_actions[], timestamp
- Action state must be one of: "started", "completed"
- If workflow resumes with action_state="started", prompt user to retry or continue that action
- Activity Log entries must include: timestamp, behavior, action, action_state, inputs, outputs, duration
- Each action start and completion must update both Workflow State AND Activity Log
- CRITICAL: correct_bot has workflow: false - it is NOT part of workflow sequence and has nothing to do with validate_rules
- CRITICAL: validate_rules has next_action: null - it is the terminal workflow action
