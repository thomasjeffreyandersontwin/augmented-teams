{
  "description": "Test files are named after sub-epics (test_sub_epic_name.py) and contain all story tests for that sub-epic. Test classes are named after stories (TestStoryName). This organization keeps related tests together while maintaining clear mapping between stories and test classes.",
  "examples": [
    {
      "do": {
        "description": "Name test file after sub-epic, test classes after stories",
        "content": [
          "# File: test_generate_bot_server_and_tools.py",
          "# Sub-epic: Generate Bot Server And Tools",
          "# Contains all stories for this sub-epic",
          "",
          "\"\"\"",
          "Generate Bot Server And Tools Tests",
          "",
          "Tests for all stories in the 'Generate Bot Server And Tools' sub-epic:",
          "- Generate MCP Bot Server",
          "- Generate Tool Definitions",
          "- Register Tools With Server",
          "\"\"\"",
          "import pytest",
          "from pathlib import Path",
          "import json",
          "",
          "# ============================================================================",
          "# HELPER FUNCTIONS",
          "# ============================================================================",
          "",
          "def create_bot_config(workspace: Path, bot_name: str) -> Path:",
          "    \"\"\"Helper: Create bot configuration file.\"\"\"",
          "    config_path = workspace / 'bots' / bot_name / 'config.json'",
          "    config_path.parent.mkdir(parents=True, exist_ok=True)",
          "    config_path.write_text(json.dumps({'name': bot_name}))",
          "    return config_path",
          "",
          "# ============================================================================",
          "# FIXTURES",
          "# ============================================================================",
          "",
          "@pytest.fixture",
          "def workspace_root(tmp_path):",
          "    \"\"\"Fixture: Temporary workspace directory.\"\"\"",
          "    workspace = tmp_path / 'workspace'",
          "    workspace.mkdir()",
          "    return workspace",
          "",
          "# ============================================================================",
          "# STORY: Generate MCP Bot Server",
          "# ============================================================================",
          "",
          "class TestGenerateMCPBotServer:",
          "    \"\"\"Story: Generate MCP Bot Server - Tests bot server generation.\"\"\"",
          "    ",
          "    def test_server_generates_with_bot_configuration(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Server generates with bot configuration",
          "        GIVEN: Bot configuration exists",
          "        WHEN: Server generator is invoked",
          "        THEN: MCP server file is generated",
          "        \"\"\"",
          "        # Given: Bot config exists",
          "        bot_config = create_bot_config(workspace_root, 'test_bot')",
          "        ",
          "        # When: Generate server",
          "        from agile_bot.bots.base_bot.src.server_generator import ServerGenerator",
          "        generator = ServerGenerator(",
          "            bot_name='test_bot',",
          "            config_path=bot_config,",
          "            workspace_root=workspace_root",
          "        )",
          "        server_file = generator.generate_server()",
          "        ",
          "        # Then: Server file created",
          "        assert server_file.exists()",
          "        assert 'mcp_server.py' in server_file.name",
          "",
          "# ============================================================================",
          "# STORY: Generate Tool Definitions",
          "# ============================================================================",
          "",
          "class TestGenerateToolDefinitions:",
          "    \"\"\"Story: Generate Tool Definitions - Tests tool definition generation.\"\"\"",
          "    ",
          "    def test_tools_generated_for_each_behavior_action(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Tools generated for each behavior action",
          "        GIVEN: Bot has behaviors with actions",
          "        WHEN: Tool generator is invoked",
          "        THEN: Tool definition created for each behavior-action pair",
          "        \"\"\"",
          "        # Given: Bot with behaviors",
          "        bot_config = create_bot_config(workspace_root, 'test_bot')",
          "        ",
          "        # When: Generate tools",
          "        from agile_bot.bots.base_bot.src.tool_generator import ToolGenerator",
          "        generator = ToolGenerator(",
          "            bot_name='test_bot',",
          "            config_path=bot_config,",
          "            workspace_root=workspace_root",
          "        )",
          "        tools = generator.generate_tool_definitions()",
          "        ",
          "        # Then: Tools created",
          "        assert len(tools) > 0",
          "        assert all('name' in tool for tool in tools)",
          "",
          "# ============================================================================",
          "# STORY: Register Tools With Server",
          "# ============================================================================",
          "",
          "class TestRegisterToolsWithServer:",
          "    \"\"\"Story: Register Tools With Server - Tests tool registration.\"\"\"",
          "    ",
          "    def test_tools_registered_with_mcp_server(self, workspace_root):",
          "        \"\"\"",
          "        SCENARIO: Tools registered with MCP server",
          "        GIVEN: Tools are generated",
          "        WHEN: Server registration is invoked",
          "        THEN: Tools are registered and callable",
          "        \"\"\"",
          "        # Given: Bot and tools exist",
          "        bot_config = create_bot_config(workspace_root, 'test_bot')",
          "        ",
          "        # When: Register tools",
          "        from agile_bot.bots.base_bot.src.server_tool_registry import ServerToolRegistry",
          "        registry = ServerToolRegistry(",
          "            bot_name='test_bot',",
          "            workspace_root=workspace_root",
          "        )",
          "        registered_tools = registry.register_all_tools()",
          "        ",
          "        # Then: Tools registered",
          "        assert len(registered_tools) > 0",
          "        assert all(tool.is_callable for tool in registered_tools)"
        ]
      },
      "dont": {
        "description": "One file per story or unclear naming",
        "content": [
          "# DON'T: One file per story (too many files)",
          "# File: test_generate_mcp_bot_server.py",
          "class TestGenerateMCPBotServer:",
          "    pass",
          "",
          "# File: test_generate_tool_definitions.py",
          "class TestGenerateToolDefinitions:",
          "    pass",
          "",
          "# File: test_register_tools_with_server.py",
          "class TestRegisterToolsWithServer:",
          "    pass",
          "",
          "# WRONG: Too many files! Should be one file per sub-epic",
          "",
          "# ============================================",
          "",
          "# DON'T: Generic class names not matching stories",
          "# File: test_server.py",
          "class TestServer:",
          "    \"\"\"Generic name - which story is this?\"\"\"",
          "    pass",
          "",
          "class TestTools:",
          "    \"\"\"Generic name - which story is this?\"\"\"",
          "    pass",
          "",
          "# WRONG: Class names don't map to story names",
          "",
          "# ============================================",
          "",
          "# DON'T: Mixing sub-epics in same file",
          "# File: test_all_bots.py",
          "class TestGenerateMCPBotServer:",
          "    \"\"\"From sub-epic: Generate Bot Server And Tools\"\"\"",
          "    pass",
          "",
          "class TestInvokeBehaviorActions:",
          "    \"\"\"From sub-epic: Invoke Behavior Actions\"\"\"",
          "    pass",
          "",
          "# WRONG: Multiple sub-epics mixed! Should be separate files"
        ]
      }
    },
    {
      "do": {
        "description": "Map story hierarchy to test structure",
        "content": [
          "# Story Hierarchy:",
          "# Epic: Build Agile Bots",
          "#   Sub-epic: Generate Bot Server And Tools",
          "#     Story: Generate MCP Bot Server",
          "#     Story: Generate Tool Definitions",
          "#     Story: Register Tools With Server",
          "#   Sub-epic: Invoke Behavior Actions",
          "#     Story: Route Tool Call To Behavior",
          "#     Story: Load Action Instructions",
          "#     Story: Execute Behavior Action",
          "",
          "# Test File Structure:",
          "# test_generate_bot_server_and_tools.py",
          "#   class TestGenerateMCPBotServer:",
          "#   class TestGenerateToolDefinitions:",
          "#   class TestRegisterToolsWithServer:",
          "",
          "# test_invoke_behavior_actions.py",
          "#   class TestRouteToolCallToBehavior:",
          "#   class TestLoadActionInstructions:",
          "#   class TestExecuteBehaviorAction:",
          "",
          "# GOOD: Clear 1-to-1 mapping:",
          "# - Sub-epic → test file",
          "# - Story → test class"
        ]
      },
      "dont": {
        "description": "Unclear mapping or inconsistent structure",
        "content": [
          "# BAD: Inconsistent naming",
          "# test_bot_server.py  (doesn't match sub-epic name)",
          "#   class TestMCPServer:  (doesn't match story name)",
          "#   class TestTools:  (doesn't match story name)",
          "",
          "# test_behaviors.py  (doesn't match sub-epic name)",
          "#   class TestRouting:  (doesn't match story name)",
          "#   class TestInstructions:  (doesn't match story name)",
          "",
          "# WRONG: Can't easily map back to story hierarchy!"
        ]
      }
    },
    {
      "do": {
        "description": "Convert sub-epic and story names to valid identifiers",
        "content": [
          "# Sub-epic: 'Generate Bot Server And Tools'",
          "# File: test_generate_bot_server_and_tools.py",
          "# - Convert to snake_case",
          "# - Remove special characters",
          "# - Keep words that identify the sub-epic",
          "",
          "# Story: 'Generate MCP Bot Server'",
          "# Class: TestGenerateMCPBotServer",
          "# - Convert to PascalCase",
          "# - Keep words that identify the story",
          "# - Prefix with 'Test'",
          "",
          "# Story: 'Bot Loads Configuration From File'",
          "# Class: TestBotLoadsConfigurationFromFile",
          "# - Full story name in PascalCase",
          "# - Clear and readable",
          "",
          "# Story: 'User Creates New Story Map'",
          "# Class: TestUserCreatesNewStoryMap",
          "# - Includes actor (User) for clarity"
        ]
      },
      "dont": {
        "description": "Abbreviated or unclear names",
        "content": [
          "# DON'T: Over-abbreviate",
          "# Story: 'Generate MCP Bot Server'",
          "# Class: TestGenMCPSrv  (too abbreviated!)",
          "",
          "# DON'T: Drop important words",
          "# Story: 'Bot Loads Configuration From File'",
          "# Class: TestBotLoadsConfig  (missing 'from file'!)",
          "",
          "# DON'T: Add words not in story",
          "# Story: 'User Creates Story Map'",
          "# Class: TestUserCreatesNewStoryMapDocument  (added 'Document'!)",
          "",
          "# WRONG: Names should match stories closely!"
        ]
      }
    }
  ],
  "rationale": [
    "Test files organized by sub-epic keep related stories together",
    "One file per sub-epic prevents excessive file proliferation",
    "Test class names matching story names create clear traceability",
    "Easy to find tests: know sub-epic → find file, know story → find class",
    "Test structure mirrors story map hierarchy for consistency",
    "Developers can navigate from story map to tests intuitively",
    "File-per-sub-epic balances organization with manageability"
  ],
  "key_principles": [
    "Test file name = sub-epic name in snake_case: test_sub_epic_name.py",
    "Test class name = EXACT story name in PascalCase: TestStoryName",
    "CRITICAL: Test class MUST match story name EXACTLY (not abbreviated, not generic)",
    "All stories in a sub-epic go in the same test file",
    "One test class per story (clear 1-to-1 mapping)",
    "File docstring lists all stories in the sub-epic",
    "Section headers separate stories within file (# STORY: Story Name)",
    "Helper functions and fixtures at top of file",
    "Test classes grouped by story in order they appear in story map",
    "BAD: TestGuardrailsInjection (generic) vs GOOD: TestInjectGuardrailsAsPartOfClarifyRequirements (exact story name)",
    "BAD: TestValidationRules (generic) vs GOOD: TestInjectValidationRulesForValidateRulesAction (exact story name)"
  ],
  "antipatterns": [
    "One test file per story (too many files)",
    "Mixing multiple sub-epics in one file (poor organization)",
    "Generic test class names that don't match stories (TestGuardrailsInjection vs TestInjectGuardrailsAsPartOfClarifyRequirements)",
    "Abbreviated names that lose clarity (TestGenSrv vs TestGenerateServer)",
    "Topic-based names instead of story names (TestValidationRules vs TestInjectValidationRulesForValidateRulesAction)",
    "Technical names instead of story names (TestContentLoading vs TestInjectLoadRenderedContentInstructions)",
    "Test files named differently from sub-epics (hard to find)",
    "Test classes named differently from stories (hard to trace)",
    "No clear structure or comments separating stories in file",
    "CRITICAL MISTAKE: Using generic class names like TestGuardrailsInjection when story is 'Inject Guardrails as Part of Clarify Requirements'"
  ],
  "file_structure_example": {
    "description": "Example test file structure for a sub-epic",
    "content": [
      "# File: test_sub_epic_name.py",
      "",
      "\"\"\"",
      "Sub-Epic Name Tests",
      "",
      "Tests for all stories in the 'Sub-Epic Name' sub-epic:",
      "- Story Name 1",
      "- Story Name 2",
      "- Story Name 3",
      "\"\"\"",
      "import pytest",
      "from pathlib import Path",
      "",
      "# ============================================================================",
      "# HELPER FUNCTIONS - Reusable operations",
      "# ============================================================================",
      "",
      "def helper_function_name(param: type) -> type:",
      "    \"\"\"Helper: Description of what this does.\"\"\"",
      "    pass",
      "",
      "# ============================================================================",
      "# FIXTURES - Test setup",
      "# ============================================================================",
      "",
      "@pytest.fixture",
      "def fixture_name(tmp_path):",
      "    \"\"\"Fixture: Description of what this provides.\"\"\"",
      "    pass",
      "",
      "# ============================================================================",
      "# STORY: Story Name 1",
      "# ============================================================================",
      "",
      "class TestStoryName1:",
      "    \"\"\"Story: Story Name 1 - Description of story.\"\"\"",
      "    ",
      "    def test_scenario_name_1(self, fixture_name):",
      "        \"\"\"",
      "        SCENARIO: Scenario description",
      "        GIVEN: Preconditions",
      "        WHEN: Action",
      "        THEN: Expected outcome",
      "        \"\"\"",
      "        # Test implementation",
      "        pass",
      "",
      "# ============================================================================",
      "# STORY: Story Name 2",
      "# ============================================================================",
      "",
      "class TestStoryName2:",
      "    \"\"\"Story: Story Name 2 - Description of story.\"\"\"",
      "    ",
      "    def test_scenario_name_2(self, fixture_name):",
      "        \"\"\"",
      "        SCENARIO: Scenario description",
      "        GIVEN: Preconditions",
      "        WHEN: Action",
      "        THEN: Expected outcome",
      "        \"\"\"",
      "        # Test implementation",
      "        pass"
    ]
  }
}

