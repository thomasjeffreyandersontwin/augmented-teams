{
  "description": "Extract duplicate test setup to reusable helper functions and factory functions. Keep test bodies focused on specific behavior being tested. Balance shared context with test-specific setup. Avoid duplication through helper extraction. From BDD Rules 8.3 (Helper Extraction) and 4 (Balance Context Sharing with Localization).",
  "examples": [
    {
      "do": {
        "description": "Extract duplicate setup to reusable helpers",
        "content": [
          "# ============================================================================",
          "# HELPER FUNCTIONS - Reusable across multiple tests",
          "# ============================================================================",
          "",
          "def create_agent_with_config(name: str, workspace: Path, config: dict) -> Agent:",
          "    \"\"\"Helper: Create agent with configuration.\"\"\"",
          "    agent = Agent(agent_name=name, workspace_root=workspace)",
          "    agent.set_config(config)",
          "    agent.initialize()",
          "    return agent",
          "",
          "def create_config_file(workspace: Path, agent_name: str) -> Path:",
          "    \"\"\"Helper: Create configuration file with agent name.\"\"\"",
          "    config_dir = workspace / 'agents' / 'base'",
          "    config_dir.mkdir(parents=True, exist_ok=True)",
          "    config_file = config_dir / 'agent.json'",
          "    config_file.write_text(json.dumps({'name': agent_name}))",
          "    return config_file",
          "",
          "def create_workspace_with_structure(tmp_path: Path) -> Path:",
          "    \"\"\"Helper: Create workspace with standard directory structure.\"\"\"",
          "    workspace = tmp_path / 'workspace'",
          "    workspace.mkdir()",
          "    (workspace / 'agents').mkdir()",
          "    (workspace / 'agents' / 'base').mkdir()",
          "    (workspace / 'data').mkdir()",
          "    return workspace",
          "",
          "def verify_agent_initialized(agent: Agent, expected_name: str):",
          "    \"\"\"Helper: Verify agent is fully initialized.\"\"\"",
          "    assert agent.is_initialized",
          "    assert agent.name == expected_name",
          "    assert agent.config_path is not None",
          "",
          "# ============================================================================",
          "# TESTS - Reuse helpers, stay focused on behavior",
          "# ============================================================================",
          "",
          "class TestAgentInitialization:",
          "    def test_agent_initializes_with_base_config(self, tmp_path):",
          "        \"\"\"Agent initializes with base configuration.\"\"\"",
          "        # Given - Use helper for setup",
          "        workspace = create_workspace_with_structure(tmp_path)",
          "        config_file = create_config_file(workspace, 'story_bot')",
          "        ",
          "        # When - Focus on behavior being tested",
          "        agent = create_agent_with_config('story_bot', workspace, {'name': 'story_bot'})",
          "        ",
          "        # Then - Use helper for verification",
          "        verify_agent_initialized(agent, 'story_bot')",
          "    ",
          "    def test_agent_loads_custom_config(self, tmp_path):",
          "        \"\"\"Agent loads custom configuration values.\"\"\"",
          "        # Given - Reuse same helpers",
          "        workspace = create_workspace_with_structure(tmp_path)",
          "        custom_config = {'name': 'custom_bot', 'version': '2.0'}",
          "        ",
          "        # When - Focus on custom config behavior",
          "        agent = create_agent_with_config('custom_bot', workspace, custom_config)",
          "        ",
          "        # Then - Reuse verification helper",
          "        verify_agent_initialized(agent, 'custom_bot')",
          "        assert agent.config['version'] == '2.0'",
          "    ",
          "    # Both tests reuse helpers - no duplication!",
          "    # Test bodies stay focused on specific behavior"
        ]
      },
      "dont": {
        "description": "Duplicate setup code across tests",
        "content": [
          "# DON'T: Duplicate setup in every test",
          "class TestAgentInitialization:",
          "    def test_agent_initializes_with_base_config(self, tmp_path):",
          "        # WRONG: Inline setup - duplicated in every test",
          "        workspace = tmp_path / 'workspace'",
          "        workspace.mkdir()",
          "        agents_dir = workspace / 'agents'",
          "        agents_dir.mkdir()",
          "        base_dir = agents_dir / 'base'",
          "        base_dir.mkdir()",
          "        config_file = base_dir / 'agent.json'",
          "        config_file.write_text('{\"name\": \"story_bot\"}')",
          "        ",
          "        agent = Agent('story_bot', workspace)",
          "        agent.initialize()",
          "        ",
          "        assert agent.is_initialized",
          "        assert agent.name == 'story_bot'",
          "        assert agent.config_path is not None",
          "    ",
          "    def test_agent_loads_custom_config(self, tmp_path):",
          "        # WRONG: Same setup duplicated again!",
          "        workspace = tmp_path / 'workspace'",
          "        workspace.mkdir()",
          "        agents_dir = workspace / 'agents'",
          "        agents_dir.mkdir()",
          "        base_dir = agents_dir / 'base'",
          "        base_dir.mkdir()",
          "        config_file = base_dir / 'agent.json'",
          "        config_file.write_text('{\"name\": \"custom_bot\", \"version\": \"2.0\"}')",
          "        ",
          "        agent = Agent('custom_bot', workspace)",
          "        agent.initialize()",
          "        ",
          "        assert agent.is_initialized",
          "        # Tons of duplication! Hard to maintain!",
          "        # If setup changes, must update all tests!"
        ]
      }
    },
    {
      "do": {
        "description": "Factory functions for test data creation",
        "content": [
          "# Factory functions create complex test data",
          "def build_test_character(name: str = 'Hero', **kwargs) -> Character:",
          "    \"\"\"Factory: Build character with default or custom attributes.\"\"\"",
          "    defaults = {",
          "        'strength': 10,",
          "        'health': 100,",
          "        'level': 1",
          "    }",
          "    defaults.update(kwargs)",
          "    return Character(name=name, **defaults)",
          "",
          "def build_test_config(overrides: dict = None) -> dict:",
          "    \"\"\"Factory: Build config with defaults and optional overrides.\"\"\"",
          "    config = {",
          "        'name': 'story_bot',",
          "        'workspace_root': '/tmp/workspace',",
          "        'version': '1.0'",
          "    }",
          "    if overrides:",
          "        config.update(overrides)",
          "    return config",
          "",
          "# Tests use factories for flexible test data",
          "def test_character_default_stats(self):",
          "    character = build_test_character()  # Uses defaults",
          "    assert character.strength == 10",
          "",
          "def test_character_custom_stats(self):",
          "    character = build_test_character(strength=15, health=120)  # Custom",
          "    assert character.strength == 15",
          "",
          "def test_agent_with_custom_config(self):",
          "    config = build_test_config({'version': '2.0'})  # Override one field",
          "    agent = Agent.from_config(config)",
          "    assert agent.version == '2.0'"
        ]
      },
      "dont": {
        "description": "Duplicate test data creation",
        "content": [
          "# DON'T: Duplicate test data creation",
          "def test_character_default_stats(self):",
          "    # WRONG: Manual construction duplicated",
          "    character = Character(",
          "        name='Hero',",
          "        strength=10,",
          "        health=100,",
          "        level=1",
          "    )",
          "    assert character.strength == 10",
          "",
          "def test_character_custom_stats(self):",
          "    # WRONG: Same manual construction with slight changes",
          "    character = Character(",
          "        name='Hero',",
          "        strength=15,  # Only difference",
          "        health=120,   # Only difference",
          "        level=1",
          "    )",
          "    # Use factory function instead!"
        ]
      }
    },
    {
      "do": {
        "description": "Use fixtures for shared setup",
        "content": [
          "# Fixtures provide shared setup across tests",
          "@pytest.fixture",
          "def workspace_root(tmp_path):",
          "    \"\"\"Fixture: Workspace with standard structure.\"\"\"",
          "    workspace = tmp_path / 'workspace'",
          "    workspace.mkdir()",
          "    (workspace / 'agents').mkdir()",
          "    (workspace / 'data').mkdir()",
          "    return workspace",
          "",
          "@pytest.fixture",
          "def base_config(workspace_root):",
          "    \"\"\"Fixture: Base configuration file.\"\"\"",
          "    config_path = workspace_root / 'agents' / 'base' / 'agent.json'",
          "    config_path.parent.mkdir(parents=True, exist_ok=True)",
          "    config_path.write_text('{\"name\": \"story_bot\"}')",
          "    return config_path",
          "",
          "@pytest.fixture",
          "def configured_agent(workspace_root, base_config):",
          "    \"\"\"Fixture: Agent with configuration loaded.\"\"\"",
          "    agent = Agent('story_bot', workspace_root)",
          "    agent.load_config(base_config)",
          "    return agent",
          "",
          "# Tests use fixtures - no setup duplication",
          "class TestAgentOperations:",
          "    def test_agent_saves_state(self, configured_agent):",
          "        \"\"\"Agent saves state to disk.\"\"\"",
          "        configured_agent.save()  # Uses fixture",
          "        assert configured_agent.state_file.exists()",
          "    ",
          "    def test_agent_loads_domain_graph(self, configured_agent, workspace_root):",
          "        \"\"\"Agent loads domain graph.\"\"\"",
          "        graph_file = workspace_root / 'domain_graph.json'",
          "        graph_file.write_text('{\"nodes\": []}')",
          "        configured_agent.load_graph(graph_file)  # Uses fixture",
          "        assert configured_agent.has_graph"
        ]
      },
      "dont": {
        "description": "Repeat fixture setup in every test",
        "content": [
          "# DON'T: Repeat setup that could be fixture",
          "class TestAgentOperations:",
          "    def test_agent_saves_state(self, tmp_path):",
          "        # WRONG: Duplicating setup in every test",
          "        workspace = tmp_path / 'workspace'",
          "        workspace.mkdir()",
          "        config_path = workspace / 'config.json'",
          "        config_path.write_text('{\"name\": \"bot\"}')",
          "        agent = Agent('bot', workspace)",
          "        agent.load_config(config_path)",
          "        # Use fixture instead!",
          "        ",
          "        agent.save()",
          "        assert agent.state_file.exists()",
          "    ",
          "    def test_agent_loads_graph(self, tmp_path):",
          "        # WRONG: Same setup repeated again!",
          "        workspace = tmp_path / 'workspace'",
          "        workspace.mkdir()",
          "        config_path = workspace / 'config.json'",
          "        config_path.write_text('{\"name\": \"bot\"}')",
          "        agent = Agent('bot', workspace)",
          "        agent.load_config(config_path)",
          "        # Create fixture for this common setup!"
        ]
      }
    },
    {
      "do": {
        "description": "Balance shared context with test-specific setup",
        "content": [
          "# Shared context via fixture",
          "@pytest.fixture",
          "def base_agent(workspace_root):",
          "    \"\"\"Fixture: Basic agent for all tests.\"\"\"",
          "    return Agent('story_bot', workspace_root)",
          "",
          "# Tests add test-specific setup",
          "class TestAgentConfiguration:",
          "    def test_agent_loads_json_config(self, base_agent, tmp_path):",
          "        \"\"\"Agent loads JSON configuration.\"\"\"",
          "        # Shared: base_agent fixture",
          "        # Test-specific: JSON config file",
          "        config_file = tmp_path / 'config.json'",
          "        config_file.write_text('{\"format\": \"json\"}')",
          "        ",
          "        base_agent.load_config(config_file)",
          "        assert base_agent.config['format'] == 'json'",
          "    ",
          "    def test_agent_loads_yaml_config(self, base_agent, tmp_path):",
          "        \"\"\"Agent loads YAML configuration.\"\"\"",
          "        # Shared: base_agent fixture",
          "        # Test-specific: YAML config file",
          "        config_file = tmp_path / 'config.yaml'",
          "        config_file.write_text('format: yaml')",
          "        ",
          "        base_agent.load_config(config_file)",
          "        assert base_agent.config['format'] == 'yaml'",
          "    ",
          "    # Balanced: Shared agent, test-specific config"
        ]
      },
      "dont": {
        "description": "Force all setup into fixture or repeat everything",
        "content": [
          "# DON'T: Force everything into shared fixture",
          "@pytest.fixture",
          "def agent_with_json_config(workspace_root, tmp_path):",
          "    # WRONG: Too specific for shared fixture",
          "    agent = Agent('story_bot', workspace_root)",
          "    config_file = tmp_path / 'config.json'",
          "    config_file.write_text('{\"format\": \"json\"}')",
          "    agent.load_config(config_file)",
          "    return agent",
          "",
          "# This fixture is too specific - can't reuse for YAML test!",
          "# Need separate fixture for each config type - wrong!",
          "",
          "# DON'T: Repeat shared setup in each test",
          "def test_loads_json_config(self, tmp_path):",
          "    # WRONG: Repeating agent creation",
          "    workspace = create_workspace(tmp_path)",
          "    agent = Agent('story_bot', workspace)  # Repeated",
          "    agent.initialize()  # Repeated",
          "    ",
          "    config_file = tmp_path / 'config.json'",
          "    config_file.write_text('{\"format\": \"json\"}')",
          "    # Agent creation should be in fixture!"
        ]
      }
    },
    {
      "do": {
        "description": "Group related helpers by purpose",
        "content": [
          "# ============================================================================",
          "# CREATION HELPERS - Build test objects",
          "# ============================================================================",
          "",
          "def create_agent(...): ...",
          "def create_config_file(...): ...",
          "def create_workspace(...): ...",
          "",
          "# ============================================================================",
          "# VERIFICATION HELPERS - Assert expected state",
          "# ============================================================================",
          "",
          "def verify_agent_initialized(...): ...",
          "def verify_config_valid(...): ...",
          "def verify_file_exists(...): ...",
          "",
          "# ============================================================================",
          "# DATA FACTORIES - Build test data",
          "# ============================================================================",
          "",
          "def build_test_character(...): ...",
          "def build_test_config(...): ...",
          "def build_test_domain_graph(...): ...",
          "",
          "# Clear organization makes helpers easy to find and reuse"
        ]
      },
      "dont": {
        "description": "Scatter helpers randomly throughout file",
        "content": [
          "# DON'T: Random helper placement",
          "def create_agent(...): ...",
          "def verify_config(...): ...",
          "def create_config(...): ...",
          "def some_test():",
          "def verify_agent(...): ...",
          "def another_test():",
          "def create_workspace(...): ...",
          "# WRONG: Helpers scattered randomly",
          "# Hard to find, hard to reuse",
          "# Group by purpose instead!"
        ]
      }
    }
  ],
  "scanner": "agile_bot.bots.base_bot.src.scanners.duplication_scanner.DuplicationScanner"
}
