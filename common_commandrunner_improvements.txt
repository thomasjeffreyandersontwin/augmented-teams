COMMON COMMAND RUNNER IMPROVEMENTS SUMMARY
==========================================

This document summarizes all the refactoring improvements made to common_command_runner.py

1. MOVED LOGIC TO DOMAIN OBJECTS
   - Removed wrapper methods from IncrementalCommand that belonged on Run class
   - Moved run state management methods to Run class:
     * verify_ai(), approve(), reject(), complete(), abandon()
     * repeat(), start()
   - Added properties to Run: generated_at, validated_at
   - Removed wrapper properties: current_run_number, run_status

2. EXTRACTED PERSISTENCE LOGIC
   - Created IncrementalState class to encapsulate state persistence
   - Moved _get_state_file_path(), _load_persisted_state(), _save_persisted_state() to IncrementalState
   - State file location now based on command file path (not BDD-specific)
   - State file: .incremental-state/{command_file}.state.json

3. REMOVED BDD-SPECIFIC METHODS
   - Removed all BDD-specific methods from IncrementalCommand:
     * start_bdd_run(), record_ai_verification(), record_human_approval()
     * complete_run(), abandon_run(), get_status_summary(), can_start_run()
   - Removed static CLI methods: show_status(), approve_run(), reject_run(), abandon_run()
   - These belong on Run class or should be handled by domain-specific commands

4. RENAMED METHODS FOR CLARITY
   - run() â†’ execute() (follows command signature pattern)
   - Removed resume_from_run() (overkill, use repeat() instead)

5. EXECUTION WORKFLOW IMPROVEMENTS
   - Added execute() method to base Command class:
     * Generates if nothing has been generated yet
     * Validates if generation has been done
   - Added execution state tracking: generated, validated flags on Command
   - IncrementalCommand.execute() adds run tracking and sample size injection

6. SAMPLE SIZE HANDLING
   - Made sample_size a property wrapper (read-only)
   - Always stored on Run object (not inner command)
   - Removed setter (unnecessary wrapper)
   - Created _inject_sample_size() method on IncrementalCommand
   - Extracted _inject_instruction_note() helper for reusable instruction injection

7. CONSOLIDATED DUPLICATED WORKFLOW
   - Created _execute_with_run_tracking() helper method
   - Consolidated generate(), validate(), execute() to use same workflow
   - Handles: run creation, sample size injection, method execution, state tracking, state saving

8. IMPROVED expand_to_all_work()
   - Now uses same workflow as execute()
   - Injects "Please finish all remaining work" instruction
   - Properly handles instruction stacking (finish note + sample size note)

9. REMOVED UNNECESSARY WRAPPERS
   - Removed complete() wrapper (call current_run.complete() directly)
   - Kept _ensure_run_exists() as private helper (appropriate abstraction)

10. STATE MANAGEMENT
    - All state persistence through self.state.load() and self.state.save()
    - State file location derived from command file path
    - More generic, not BDD-specific

KEY PRINCIPLES APPLIED:
- Single Responsibility: Each class has one clear purpose
- Don't Wrap Domain Objects: Direct access to Run, RunHistory, IncrementalState
- Move Logic Down: Business logic belongs on domain objects, not wrappers
- Reduce Surface Area: Eliminate unnecessary wrapper methods
- Encapsulation: State persistence encapsulated in IncrementalState
- DRY: Consolidated duplicated workflow into helper method

